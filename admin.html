<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è€é­š oldfish - æ‚„æ‚„è©±ç®¡ç†å¾Œå°">
    <title>æ‚„æ‚„è©±ç®¡ç†å¾Œå° - è€é­šoldfish</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script>
        // åœ¨é é¢æ¸²æŸ“å‰ç«‹å³è®€å–ä¸¦æ‡‰ç”¨ä¸»é¡Œè¨­å®šï¼Œé¿å…é–ƒçˆ
        (function() {
            // å„ªå…ˆè®€å– URL åƒæ•¸ï¼ˆè·³è½‰æ™‚å‚³éçš„ä¸»é¡Œï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const urlTheme = urlParams.get('theme');
            let theme;

            if (urlTheme === 'dark' || urlTheme === 'light') {
                // å¦‚æœ URL ä¸­æœ‰ä¸»é¡Œåƒæ•¸ï¼Œä½¿ç”¨å®ƒä¸¦æ›´æ–° localStorage
                theme = urlTheme;
                localStorage.setItem('theme', theme);
            } else {
                // å¦å‰‡å¾ localStorage è®€å–
                theme = localStorage.getItem('theme') || 'dark';
            }
            
            document.documentElement.setAttribute('data-theme', theme);
            if (document.body) {
                document.body.setAttribute('data-theme', theme);
            }
        })();
    </script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .admin-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .admin-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .messages-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .messages-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .messages-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .messages-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .message-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }
        
        .message-item:hover {
            background: var(--bg-section);
        }
        
        .message-item:last-child {
            border-bottom: none;
        }
        
        .message-item.unread {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .message-info {
            flex: 1;
        }
        
        .message-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .message-time {
            color: var(--text-light);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .message-content {
            color: var(--text-primary);
            line-height: 1.6;
            white-space: pre-wrap;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-main);
            border-radius: 8px;
        }
        
        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-mark-read {
            background: var(--primary);
            color: white;
        }
        
        .btn-mark-read:hover {
            background: var(--primary-dark);
        }
        
        .btn-delete {
            background: var(--accent);
            color: white;
        }
        
        .btn-delete:hover {
            background: #7C3AED;
        }
        
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-state-text {
            font-size: 1.2rem;
        }
        
        .refresh-btn {
            padding: 0.75rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }
            
            .admin-title {
                font-size: 2rem;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .message-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .message-time {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è£é£¾å…ƒç´  -->
    <div class="bg-decoration">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
    </div>
    <div class="page-glass-bg"></div>

    <main class="page-content">
        <!-- å°èˆªåˆ— -->
        <nav class="navbar" id="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <a href="https://oldfish101240.github.io/oldfish-profile/index.html" style="text-decoration: none; color: inherit;">
                        <span class="logo-text">è€é­šoldfish</span>
                    </a>
                </div>
            <div class="nav-actions">
                <a href="https://oldfish101240.github.io/oldfish-profile/index.html" class="nav-link">é¦–é </a>
                <a href="https://oldfish101240.github.io/oldfish-profile/about.html" class="nav-link">é—œæ–¼æˆ‘</a>
                <a href="https://oldfish101240.github.io/oldfish-profile/portfolio.html" class="nav-link">ä½œå“</a>
                <a href="https://oldfish101240.github.io/oldfish-profile/contact.html" class="nav-link">æ‚„æ‚„è©±</a>
                <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œ">
                    <img src="assets/light-b.png" alt="åˆ‡æ›ç‚ºäº®è‰²ä¸»é¡Œ" class="theme-icon theme-icon-sun">
                    <img src="assets/dark-w.png" alt="åˆ‡æ›ç‚ºæš—è‰²ä¸»é¡Œ" class="theme-icon theme-icon-moon">
                </button>
            </div>
            </div>
        </nav>

        <!-- ç®¡ç†å¾Œå°å…§å®¹ -->
        <section class="section section-contact" style="padding-top: 8rem;">
            <div class="admin-container">
            <div class="admin-header">
                <h1 class="admin-title">æ‚„æ‚„è©±ç®¡ç†å¾Œå°</h1>
                <p class="admin-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ”¶åˆ°çš„æ‚„æ‚„è©±è¨Šæ¯</p>
            </div>
            
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-label">ç¸½è¨Šæ¯æ•¸</div>
                    <div class="stat-value" id="totalMessages">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœªè®€è¨Šæ¯</div>
                    <div class="stat-value" id="unreadMessages">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·²è®€è¨Šæ¯</div>
                    <div class="stat-value" id="readMessages">0</div>
                </div>
            </div>
            
            <!-- è¨Šæ¯åˆ—è¡¨ -->
            <div class="messages-container">
                <div class="messages-header">
                    <h2 class="messages-title">æ‰€æœ‰è¨Šæ¯</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="refresh-btn" onclick="loadMessages()">ğŸ”„ é‡æ–°æ•´ç†</button>
                        <button class="refresh-btn" onclick="showChangePasswordDialog()" style="background: var(--gradient-secondary);">ğŸ” æ›´æ”¹å¯†ç¢¼</button>
                    </div>
                </div>
                <div class="messages-list" id="messagesList">
                    <!-- è¨Šæ¯å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            </div>
        </section>
    </main>

    <!-- é å°¾ -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; <button type="button" class="year-trigger" data-launch="2025/11/23" aria-label="æŸ¥çœ‹å»ºç«™è³‡è¨Š">2025</button> è€é­š oldfish.</p>
                <p class="footer-note">(æœ¬é é¢ç”±cursorè¼”åŠ©è£½ä½œ)</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // ============================================
        // å¯†ç¢¼ä¿è­·ï¼ˆä½¿ç”¨é›œæ¹Šï¼‰
        // ============================================
        const PASSWORD_HASH_KEY = 'admin_password_hash';
        const AUTH_KEY = 'admin_authenticated';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24å°æ™‚
        
        // ä½¿ç”¨ SHA-256 é›œæ¹Šå¯†ç¢¼
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼ï¼ˆåƒ…åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ï¼‰
        async function initDefaultPassword() {
            const existingHash = localStorage.getItem(PASSWORD_HASH_KEY);
            if (!existingHash) {
                // é è¨­å¯†ç¢¼ï¼šAndy0228
                const defaultHash = await hashPassword('Andy0228');
                localStorage.setItem(PASSWORD_HASH_KEY, defaultHash);
                console.log('å·²åˆå§‹åŒ–é è¨­å¯†ç¢¼');
            }
        }
        
        // é©—è­‰å¯†ç¢¼
        async function verifyPassword(inputPassword) {
            const storedHash = localStorage.getItem(PASSWORD_HASH_KEY);
            if (!storedHash) {
                await initDefaultPassword();
                return await verifyPassword(inputPassword);
            }
            const inputHash = await hashPassword(inputPassword);
            return inputHash === storedHash;
        }
        
        // æ›´æ”¹å¯†ç¢¼
        async function changePassword(oldPassword, newPassword) {
            const isValid = await verifyPassword(oldPassword);
            if (!isValid) {
                return { success: false, message: 'èˆŠå¯†ç¢¼éŒ¯èª¤' };
            }
            if (newPassword.length < 4) {
                return { success: false, message: 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 4 å€‹å­—å…ƒ' };
            }
            const newHash = await hashPassword(newPassword);
            localStorage.setItem(PASSWORD_HASH_KEY, newHash);
            // æ¸…é™¤ç•¶å‰èªè­‰ï¼Œéœ€è¦é‡æ–°ç™»å…¥
            sessionStorage.removeItem(AUTH_KEY);
            return { success: true, message: 'å¯†ç¢¼å·²æ›´æ”¹ï¼Œè«‹é‡æ–°ç™»å…¥' };
        }
        
        function checkAuth() {
            const authData = sessionStorage.getItem(AUTH_KEY);
            if (authData) {
                const { timestamp, authenticated } = JSON.parse(authData);
                const now = Date.now();
                // æª¢æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆæ™‚é–“å…§ï¼ˆ24å°æ™‚ï¼‰
                if (authenticated && (now - timestamp) < SESSION_DURATION) {
                    return true;
                } else {
                    // éæœŸï¼Œæ¸…é™¤èªè­‰
                    sessionStorage.removeItem(AUTH_KEY);
                }
            }
            return false;
        }
        
        function showPasswordPrompt() {
            // éš±è—ä¸»è¦å…§å®¹
            const mainContent = document.querySelector('.section');
            if (mainContent) {
                mainContent.style.display = 'none';
            }
            
            // å‰µå»ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
            const passwordContainer = document.createElement('div');
            passwordContainer.id = 'passwordContainer';
            passwordContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--bg-main);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            passwordContainer.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 3rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                ">
                    <h2 style="
                        font-size: 2rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 0.5rem;
                    ">ç®¡ç†å¾Œå°</h2>
                    <p style="
                        color: var(--text-secondary);
                        margin-bottom: 2rem;
                    ">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
                    <input type="password" id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" style="
                        width: 100%;
                        padding: 1rem;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        background: var(--bg-main);
                        color: var(--text-primary);
                        font-size: 1rem;
                        margin-bottom: 1rem;
                        font-family: inherit;
                        transition: all 0.3s ease;
                    " autofocus>
                    <div id="errorMessage" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <button id="submitPassword" style="
                        width: 100%;
                        padding: 1rem;
                        background: var(--gradient-primary);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 1.1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">ç¢ºèª</button>
                </div>
            `;
            
            document.body.appendChild(passwordContainer);
            
            const passwordInput = document.getElementById('passwordInput');
            const submitBtn = document.getElementById('submitPassword');
            const errorMsg = document.getElementById('errorMessage');
            
            async function handleSubmit() {
                const password = passwordInput.value.trim();
                if (!password) {
                    errorMsg.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'é©—è­‰ä¸­...';
                
                try {
                    // åˆå§‹åŒ–é è¨­å¯†ç¢¼ï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰
                    await initDefaultPassword();
                    
                    const isValid = await verifyPassword(password);
                    if (isValid) {
                        // èªè­‰æˆåŠŸ
                        const authData = {
                            authenticated: true,
                            timestamp: Date.now()
                        };
                        sessionStorage.setItem(AUTH_KEY, JSON.stringify(authData));
                        passwordContainer.remove();
                        if (mainContent) {
                            mainContent.style.display = '';
                        }
                        // è¼‰å…¥è¨Šæ¯
                        if (typeof loadMessages === 'function') {
                            loadMessages();
                        }
                    } else {
                        // å¯†ç¢¼éŒ¯èª¤
                        errorMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';
                        errorMsg.style.display = 'block';
                        passwordInput.value = '';
                        passwordInput.focus();
                        passwordInput.style.borderColor = '#EF4444';
                        setTimeout(() => {
                            passwordInput.style.borderColor = '';
                        }, 2000);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ç¢ºèª';
                    }
                } catch (error) {
                    console.error('é©—è­‰å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç¢ºèª';
                }
            }
            
            submitBtn.addEventListener('click', handleSubmit);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
            });
        }
        
        // æ›´æ”¹å¯†ç¢¼å°è©±æ¡†
        function showChangePasswordDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'changePasswordDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 2.5rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 450px;
                    width: 90%;
                ">
                    <h3 style="
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 1.5rem;
                    ">æ›´æ”¹å¯†ç¢¼</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">èˆŠå¯†ç¢¼</label>
                        <input type="password" id="oldPasswordInput" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        " autofocus>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPasswordInput" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘4å€‹å­—å…ƒï¼‰" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        ">
                    </div>
                    <div id="changePasswordError" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div id="changePasswordSuccess" style="
                        color: #10B981;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button id="confirmChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--gradient-primary);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">ç¢ºèªæ›´æ”¹</button>
                        <button id="cancelChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--bg-section);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmBtn = document.getElementById('confirmChangePassword');
            const cancelBtn = document.getElementById('cancelChangePassword');
            const errorMsg = document.getElementById('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            
            async function handleChangePassword() {
                const oldPassword = oldPasswordInput.value.trim();
                const newPassword = newPasswordInput.value.trim();
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                if (!oldPassword || !newPassword) {
                    errorMsg.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'è™•ç†ä¸­...';
                
                try {
                    const result = await changePassword(oldPassword, newPassword);
                    if (result.success) {
                        successMsg.textContent = result.message;
                        successMsg.style.display = 'block';
                        setTimeout(() => {
                            dialog.remove();
                            // é‡æ–°é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
                            showPasswordPrompt();
                        }, 2000);
                    } else {
                        errorMsg.textContent = result.message;
                        errorMsg.style.display = 'block';
                        oldPasswordInput.value = '';
                        newPasswordInput.value = '';
                        oldPasswordInput.focus();
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                    }
                } catch (error) {
                    console.error('æ›´æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                }
            }
            
            confirmBtn.addEventListener('click', handleChangePassword);
            cancelBtn.addEventListener('click', () => dialog.remove());
            
            // Enter éµæäº¤
            newPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChangePassword();
                }
            });
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼
        initDefaultPassword();
        
        // æ›´æ”¹å¯†ç¢¼å°è©±æ¡†
        function showChangePasswordDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'changePasswordDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 2.5rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 450px;
                    width: 90%;
                ">
                    <h3 style="
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 1.5rem;
                    ">æ›´æ”¹å¯†ç¢¼</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">èˆŠå¯†ç¢¼</label>
                        <input type="password" id="oldPasswordInput" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        " autofocus>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPasswordInput" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘4å€‹å­—å…ƒï¼‰" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        ">
                    </div>
                    <div id="changePasswordError" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div id="changePasswordSuccess" style="
                        color: #10B981;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button id="confirmChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--gradient-primary);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">ç¢ºèªæ›´æ”¹</button>
                        <button id="cancelChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--bg-section);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmBtn = document.getElementById('confirmChangePassword');
            const cancelBtn = document.getElementById('cancelChangePassword');
            const errorMsg = document.getElementById('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            
            async function handleChangePassword() {
                const oldPassword = oldPasswordInput.value.trim();
                const newPassword = newPasswordInput.value.trim();
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                if (!oldPassword || !newPassword) {
                    errorMsg.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'è™•ç†ä¸­...';
                
                try {
                    const result = await changePassword(oldPassword, newPassword);
                    if (result.success) {
                        successMsg.textContent = result.message;
                        successMsg.style.display = 'block';
                        setTimeout(() => {
                            dialog.remove();
                            // é‡æ–°é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
                            showPasswordPrompt();
                        }, 2000);
                    } else {
                        errorMsg.textContent = result.message;
                        errorMsg.style.display = 'block';
                        oldPasswordInput.value = '';
                        newPasswordInput.value = '';
                        oldPasswordInput.focus();
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                    }
                } catch (error) {
                    console.error('æ›´æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                }
            }
            
            confirmBtn.addEventListener('click', handleChangePassword);
            cancelBtn.addEventListener('click', () => dialog.remove());
            
            // Enter éµæäº¤
            newPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChangePassword();
                }
            });
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼
        initDefaultPassword();
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥èªè­‰
        if (!checkAuth()) {
            // å¦‚æœ DOM å·²è¼‰å…¥ï¼Œç«‹å³é¡¯ç¤ºå¯†ç¢¼æç¤º
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showPasswordPrompt);
            } else {
                showPasswordPrompt();
            }
        }
        
        // è¼‰å…¥è¨Šæ¯
        async function loadMessages() {
            const messagesListEl = document.getElementById('messagesList');
            if (!messagesListEl) {
                console.error('æ‰¾ä¸åˆ° messagesList å…ƒç´ ');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            messagesListEl.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <div class="empty-state-text">è¼‰å…¥ä¸­...</div>
                </div>
            `;
            
            // ä½¿ç”¨ GitHub Issues APIï¼ˆé€šéå¾Œç«¯ä»£ç†ï¼‰
            // è¨­ç½®æ­¥é©Ÿï¼š
            // 1. éƒ¨ç½² api/get-issues.js åˆ° Vercel/Netlify
            // 2. å°‡ä¸‹é¢çš„ API_ENDPOINT æ›¿æ›ç‚ºä½ çš„ API URL
            
            const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-issues'; // æ›¿æ›ç‚ºå¯¦éš›çš„ API URL
            const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
            
            let messages = [];
            
            if (useAPI) {
                try {
                    // å¾ GitHub Issues API è®€å–
                    const response = await fetch(API_ENDPOINT);
                    const data = await response.json();
                    
                    if (data.success && data.messages) {
                        messages = data.messages;
                        console.log('å¾ GitHub Issues è¼‰å…¥è¨Šæ¯æ•¸é‡:', messages.length);
                    } else {
                        throw new Error(data.error || 'è®€å–å¤±æ•—');
                    }
                } catch (error) {
                    console.error('å¾ API è®€å–è¨Šæ¯å¤±æ•—:', error);
                    messagesListEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">ç„¡æ³•è¼‰å…¥è¨Šæ¯</div>
                            <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                éŒ¯èª¤ï¼š${error.message}
                            </div>
                        </div>
                    `;
                    return;
                }
            } else {
                // å‚™ç”¨æ–¹æ¡ˆï¼šå¾ localStorage è®€å–ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰
                console.warn('âš ï¸ API ç«¯é»æœªè¨­ç½®ï¼Œä½¿ç”¨ localStorage ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ');
                
                if (typeof(Storage) === "undefined") {
                    messagesListEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">ç€è¦½å™¨ä¸æ”¯æ´ localStorage</div>
                        </div>
                    `;
                    return;
                }
                
                const rawData = localStorage.getItem('whisperMessages');
                if (rawData) {
                    try {
                        messages = JSON.parse(rawData);
                        if (!Array.isArray(messages)) {
                            messages = [];
                        }
                    } catch (error) {
                        console.error('è§£æè¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        messages = [];
                    }
                }
                
                console.log('å¾ localStorage è¼‰å…¥è¨Šæ¯æ•¸é‡:', messages.length);
            }
            
            // æ›´æ–°çµ±è¨ˆ
            const total = messages.length;
            const unread = messages.filter(m => !m.read).length;
            const read = total - unread;
            
            const totalEl = document.getElementById('totalMessages');
            const unreadEl = document.getElementById('unreadMessages');
            const readEl = document.getElementById('readMessages');
            
            if (totalEl) totalEl.textContent = total;
            if (unreadEl) unreadEl.textContent = unread;
            if (readEl) readEl.textContent = read;
            
            // æ¸…ç©ºåˆ—è¡¨
            messagesListEl.innerHTML = '';
            
            if (messages.length === 0) {
                messagesListEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-text">ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯</div>
                        <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                            æç¤ºï¼šè«‹åœ¨ contact.html æäº¤è¨Šæ¯å¾Œå†ä¾†æŸ¥çœ‹
                        </div>
                    </div>
                `;
                return;
            }
            
            // é¡¯ç¤ºè¨Šæ¯
            messages.forEach((message) => {
                // ç¢ºä¿è¨Šæ¯æœ‰å¿…è¦çš„æ¬„ä½
                if (!message.id || !message.name || !message.message) {
                    console.warn('è¨Šæ¯è³‡æ–™ä¸å®Œæ•´ï¼Œè·³é:', message);
                    return;
                }
                
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${message.read ? '' : 'unread'}`;
                messageItem.id = `message-${message.id}`;
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                let formattedDate = 'æœªçŸ¥æ™‚é–“';
                try {
                    const date = new Date(message.timestamp);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toLocaleString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (e) {
                    console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±æ•—:', e);
                }
                
                // å¦‚æœæœ‰ Issue URLï¼Œæ·»åŠ é€£çµ
                const issueLink = message.issueUrl ? 
                    `<a href="${message.issueUrl}" target="_blank" style="color: var(--primary); text-decoration: none; margin-left: 0.5rem;">#${message.issueNumber}</a>` : 
                    '';
                
                messageItem.innerHTML = `
                    <div class="message-header">
                        <div class="message-info">
                            <div class="message-name">${escapeHtml(message.name || 'æœªæä¾›')}${issueLink}</div>
                        </div>
                        <div class="message-time">${formattedDate}</div>
                    </div>
                    <div class="message-content">${escapeHtml(message.message || '')}</div>
                    <div class="message-actions">
                        ${!message.read ? `<button class="btn-action btn-mark-read" onclick="markAsRead(${message.id})">æ¨™è¨˜ç‚ºå·²è®€</button>` : ''}
                        <button class="btn-action btn-delete" onclick="deleteMessage(${message.id})">åˆªé™¤</button>
                        ${message.issueUrl ? `<a href="${message.issueUrl}" target="_blank" class="btn-action" style="background: var(--bg-section); color: var(--text-primary); text-decoration: none; display: inline-block;">åœ¨ GitHub æŸ¥çœ‹</a>` : ''}
                    </div>
                `;
                
                messagesListEl.appendChild(messageItem);
            });
        }
        
        // æ¨™è¨˜ç‚ºå·²è®€ï¼ˆé—œé–‰ GitHub Issueï¼‰
        async function markAsRead(id) {
            try {
                const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-issues';
                const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
                
                if (useAPI && typeof id === 'number' && id > 0) {
                    // ä½¿ç”¨ GitHub Issues API é—œé–‰ Issue
                    const closeApiEndpoint = 'https://oldfish-profile.vercel.app/api/close-issue';
                    
                    const response = await fetch(closeApiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            issueNumber: id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // æˆåŠŸé—œé–‰ Issueï¼Œé‡æ–°è¼‰å…¥è¨Šæ¯
                        loadMessages();
                    } else {
                        throw new Error(data.error || 'é—œé–‰ Issue å¤±æ•—');
                    }
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ localStorageï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰
                    const rawData = localStorage.getItem('whisperMessages');
                    if (rawData) {
                        let messages = JSON.parse(rawData);
                        if (Array.isArray(messages)) {
                            const message = messages.find(m => m.id === id);
                            if (message) {
                                message.read = true;
                                localStorage.setItem('whisperMessages', JSON.stringify(messages));
                            }
                        }
                    }
                    
                    // é‡æ–°è¼‰å…¥è¨Šæ¯
                    loadMessages();
                }
            } catch (error) {
                console.error('æ¨™è¨˜ç‚ºå·²è®€æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('æ“ä½œå¤±æ•—ï¼š' + (error.message || 'è«‹é‡è©¦'));
            }
        }
        
        // åˆªé™¤è¨Šæ¯ï¼ˆé—œé–‰ GitHub Issueï¼‰
        async function deleteMessage(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡è¨Šæ¯å—ï¼Ÿé€™å°‡æœƒé—œé–‰ GitHub Issueã€‚')) {
                return;
            }
            
            try {
                const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-issues';
                const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
                
                if (useAPI && typeof id === 'number' && id > 0) {
                    // ä½¿ç”¨ GitHub Issues API é—œé–‰ Issue
                    const closeApiEndpoint = 'https://oldfish-profile.vercel.app/api/close-issue';
                    
                    const response = await fetch(closeApiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            issueNumber: id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // æˆåŠŸé—œé–‰ Issueï¼Œé‡æ–°è¼‰å…¥è¨Šæ¯
                        loadMessages();
                    } else {
                        throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                    }
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ localStorageï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰
                    const rawData = localStorage.getItem('whisperMessages');
                    if (rawData) {
                        let messages = JSON.parse(rawData);
                        if (Array.isArray(messages)) {
                            messages = messages.filter(m => m.id !== id);
                            localStorage.setItem('whisperMessages', JSON.stringify(messages));
                        }
                    }
                    
                    // é‡æ–°è¼‰å…¥è¨Šæ¯
                    loadMessages();
                }
            } catch (error) {
                console.error('åˆªé™¤è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + (error.message || 'è«‹é‡è©¦'));
            }
        }
        
        // HTML è½‰ç¾©ï¼ˆé˜²æ­¢ XSSï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // é é¢è¼‰å…¥æ™‚è¼‰å…¥è¨Šæ¯
        function initAdmin() {
            console.log('ç®¡ç†å¾Œå°é é¢å·²è¼‰å…¥');
            try {
                loadMessages();
            } catch (error) {
                console.error('è¼‰å…¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                const messagesList = document.getElementById('messagesList');
                if (messagesList) {
                    messagesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">è¼‰å…¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤</div>
                            <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                éŒ¯èª¤ï¼š${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAdmin);
        } else {
            // å¦‚æœ DOM å·²è¼‰å…¥ï¼Œç¨ç­‰ä¸€ä¸‹ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“
            setTimeout(initAdmin, 100);
        }
        
        // æ·»åŠ èª¿è©¦åŠŸèƒ½ï¼šåœ¨æ§åˆ¶å°é¡¯ç¤ºæ‰€æœ‰è¨Šæ¯
        window.debugMessages = function() {
            const messages = JSON.parse(localStorage.getItem('whisperMessages') || '[]');
            console.table(messages);
            console.log('è¨Šæ¯æ•¸é‡:', messages.length);
            return messages;
        };
        
        // æ‰‹å‹•é‡æ–°è¼‰å…¥è¨Šæ¯
        window.reloadMessages = function() {
            console.log('æ‰‹å‹•é‡æ–°è¼‰å…¥è¨Šæ¯');
            loadMessages();
        };
        
        console.log('æç¤ºï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ debugMessages() å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è¨Šæ¯');
        console.log('æç¤ºï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ reloadMessages() å¯ä»¥é‡æ–°è¼‰å…¥è¨Šæ¯');
    </script>
</body>
</html>

