<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è€é­šoldfish - æ‚„æ‚„è©±ç®¡ç†å¾Œå°">
    <title>æ‚„æ‚„è©±ç®¡ç†å¾Œå° - è€é­šoldfish</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // åœ¨é é¢æ¸²æŸ“å‰ç«‹å³è®€å–ä¸¦æ‡‰ç”¨ä¸»é¡Œè¨­å®šï¼Œé¿å…é–ƒçˆ
        (function() {
            // å„ªå…ˆè®€å– URL åƒæ•¸ï¼ˆè·³è½‰æ™‚å‚³éçš„ä¸»é¡Œï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const urlTheme = urlParams.get('theme');
            let theme;

            if (urlTheme === 'dark' || urlTheme === 'light') {
                // å¦‚æœ URL ä¸­æœ‰ä¸»é¡Œåƒæ•¸ï¼Œä½¿ç”¨å®ƒä¸¦æ›´æ–° localStorage
                theme = urlTheme;
                localStorage.setItem('theme', theme);
            } else {
                // å¦å‰‡å¾ localStorage è®€å–
                theme = localStorage.getItem('theme') || 'dark';
            }
            
            document.documentElement.setAttribute('data-theme', theme);
            if (document.body) {
                document.body.setAttribute('data-theme', theme);
            }
        })();
    </script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .admin-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .admin-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .messages-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .messages-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .messages-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .messages-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .message-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }
        
        .message-item:hover {
            background: var(--bg-section);
        }
        
        .message-item:last-child {
            border-bottom: none;
        }
        
        .message-item.unread {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .message-info {
            flex: 1;
        }
        
        .message-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .message-time {
            color: var(--text-light);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .message-content {
            color: var(--text-primary);
            line-height: 1.6;
            white-space: pre-wrap;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-main);
            border-radius: 8px;
        }
        
        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-mark-read {
            background: var(--primary);
            color: white;
        }
        
        .btn-mark-read:hover {
            background: var(--primary-dark);
        }
        
        .btn-delete {
            background: var(--accent);
            color: white;
        }
        
        .btn-delete:hover {
            background: #7C3AED;
        }
        
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-state-text {
            font-size: 1.2rem;
        }
        
        .refresh-btn {
            padding: 0.75rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* Tab å°èˆªæ¨£å¼ */
        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .admin-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: inherit;
        }
        
        .admin-tab:hover {
            color: var(--primary);
        }
        
        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .admin-tab-content {
            position: relative;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* åœ–è¡¨å®¹å™¨ */
        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .chart-container {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .chart-container h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .chart-container canvas {
            max-height: 300px;
        }
        
        /* åˆ†æçµ±è¨ˆ */
        .analytics-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            padding: 2rem;
        }
        
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .analytics-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .analytics-stat-card {
            background: var(--bg-section);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .analytics-stat-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        #pageRankingList {
            list-style: none;
            padding: 0;
        }
        
        #pageRankingList li {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-card);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* éæ¿¾å™¨ç®¡ç† */
        .filters-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            padding: 2rem;
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .filters-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .filter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .filters-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .filter-item {
            background: var(--bg-section);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .filter-item-info {
            flex: 1;
        }
        
        .filter-item-word {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .filter-item-category {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .filter-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* åŠŸèƒ½é–‹é—œ */
        .settings-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            padding: 2rem;
        }
        
        .settings-container h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2rem;
        }
        
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--bg-section);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .setting-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .setting-info p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: var(--gradient-primary);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* ç³»çµ±è¨­å®š */
        .system-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            padding: 2rem;
        }
        
        .system-container h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2rem;
        }
        
        .system-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        /* æ‰¹é‡æ“ä½œæŒ‰éˆ• */
        .message-item {
            position: relative;
        }
        
        .message-item input[type="checkbox"] {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
        }
        
        .message-item.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }
            
            .admin-title {
                font-size: 2rem;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .admin-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .admin-tab {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            .dashboard-charts {
                grid-template-columns: 1fr;
            }
            
            .analytics-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .message-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .message-time {
                font-size: 0.8rem;
            }
            
            .filters-header,
            .analytics-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }

        /* éæ¿¾å™¨ï¼šæ””æˆªå…§å®¹å€å¡Š */
        .blocked-logs {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .blocked-logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .blocked-logs-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .blocked-log-item {
            background: var(--bg-section);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
        }
        .blocked-log-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }
        .blocked-log-meta .left {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .blocked-log-meta .right {
            color: var(--text-light);
            font-size: 0.85rem;
        }
        .blocked-log-tags {
            margin-bottom: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .blocked-tag {
            background: rgba(139, 92, 246, 0.12);
            border: 1px solid rgba(139, 92, 246, 0.25);
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85rem;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
        }
        .blocked-log-content details {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
        }
        .blocked-log-content summary {
            cursor: pointer;
            color: var(--primary);
            font-weight: 700;
        }
        .blocked-log-content pre {
            white-space: pre-wrap;
            word-break: break-word;
            margin-top: 0.75rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* å³ä¸‹è§’ FAB */
        .admin-fab {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 9999;
            width: 52px;
            height: 52px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            font-size: 22px;
            font-weight: 900;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .admin-fab:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: var(--shadow-xl);
        }
        .admin-fab:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è£é£¾å…ƒç´  -->
    <div class="bg-decoration">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
    </div>
    <div class="page-glass-bg"></div>

    <main class="page-content">
        <!-- å°èˆªåˆ— -->
        <nav class="navbar" id="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <a href="https://oldfish101240.github.io/oldfish-profile/index.html" style="text-decoration: none; color: inherit;">
                        <span class="logo-text">è€é­šoldfish</span>
                    </a>
                </div>
            <div class="nav-actions">
                <a href="https://oldfish101240.github.io/oldfish-profile/index.html" class="nav-link">é¦–é </a>
                <a href="https://oldfish101240.github.io/oldfish-profile/about.html" class="nav-link">é—œæ–¼æˆ‘</a>
                <a href="https://oldfish101240.github.io/oldfish-profile/portfolio.html" class="nav-link">ä½œå“</a>
                <a href="https://oldfish101240.github.io/oldfish-profile/contact.html" class="nav-link">æ‚„æ‚„è©±</a>
                <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œ">
                    <img src="assets/light-b.png" alt="åˆ‡æ›ç‚ºäº®è‰²ä¸»é¡Œ" class="theme-icon theme-icon-sun">
                    <img src="assets/dark-w.png" alt="åˆ‡æ›ç‚ºæš—è‰²ä¸»é¡Œ" class="theme-icon theme-icon-moon">
                </button>
            </div>
            </div>
        </nav>

        <!-- ç®¡ç†å¾Œå°å…§å®¹ -->
        <section class="section section-contact" style="padding-top: 8rem;">
            <div class="admin-container">
            <div class="admin-header">
                <h1 class="admin-title">ç¶²ç«™ç®¡ç†å¾Œå°</h1>
                <p class="admin-subtitle">ç®¡ç†ç¶²ç«™çµ±è¨ˆã€æ‚„æ‚„è©±ã€éæ¿¾å™¨å’ŒåŠŸèƒ½é–‹é—œ</p>
            </div>
            
            <!-- Tab å°èˆª -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="dashboard">ğŸ“Š å„€è¡¨æ¿</button>
                <button class="admin-tab" data-tab="messages">ğŸ’¬ æ‚„æ‚„è©±ç®¡ç†</button>
                <button class="admin-tab" data-tab="analytics">ğŸ“ˆ ç¶²ç«™çµ±è¨ˆ</button>
                <button class="admin-tab" data-tab="filters">ğŸ” éæ¿¾å™¨ç®¡ç†</button>
                <button class="admin-tab" data-tab="settings">âš™ï¸ åŠŸèƒ½é–‹é—œ</button>
                <button class="admin-tab" data-tab="system">ğŸ” ç³»çµ±è¨­å®š</button>
            </div>
            
            <!-- Tab å…§å®¹å€åŸŸ -->
            <div class="admin-tab-content">
                <!-- å„€è¡¨æ¿ Tab -->
                <div class="tab-panel active" id="dashboard-panel">
                    <div class="admin-stats">
                        <div class="stat-card">
                            <div class="stat-label">ç¸½ç€è¦½äººæ¬¡</div>
                            <div class="stat-value" id="totalViews">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ä»Šæ—¥ç€è¦½é‡</div>
                            <div class="stat-value" id="todayViews">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœ¬é€±ç€è¦½é‡</div>
                            <div class="stat-value" id="weekViews">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœ¬æœˆç€è¦½é‡</div>
                            <div class="stat-value" id="monthViews">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ç¸½è¨Šæ¯æ•¸</div>
                            <div class="stat-value" id="totalMessages">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœªè®€è¨Šæ¯</div>
                            <div class="stat-value" id="unreadMessages">0</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-charts">
                        <div class="chart-container">
                            <h3>æœ€è¿‘ 30 å¤©ç€è¦½é‡è¶¨å‹¢</h3>
                            <canvas id="viewsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>é é¢ç€è¦½æ’è¡Œ</h3>
                            <canvas id="pagesChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- æ‚„æ‚„è©±ç®¡ç† Tab -->
                <div class="tab-panel" id="messages-panel">
                    <div class="messages-container">
                        <div class="messages-header">
                            <h2 class="messages-title">æ‰€æœ‰è¨Šæ¯</h2>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="refresh-btn" onclick="loadMessages()">ğŸ”„ é‡æ–°æ•´ç†</button>
                                <button class="refresh-btn" id="selectAllBtn" onclick="toggleSelectAll()">â˜‘ï¸ å…¨é¸</button>
                                <button class="refresh-btn" id="bulkMarkReadBtn" onclick="bulkMarkAsRead()" style="display: none;">âœ“ æ‰¹é‡æ¨™è¨˜å·²è®€</button>
                                <button class="refresh-btn" id="bulkDeleteBtn" onclick="bulkDelete()" style="display: none; background: var(--accent);">ğŸ—‘ï¸ æ‰¹é‡åˆªé™¤</button>
                            </div>
                        </div>
                        <div class="messages-list" id="messagesList">
                            <!-- è¨Šæ¯å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                </div>
                
                <!-- ç¶²ç«™çµ±è¨ˆ Tab -->
                <div class="tab-panel" id="analytics-panel">
                    <div class="analytics-container">
                        <div class="analytics-header">
                            <h2>ç¶²ç«™çµ±è¨ˆåˆ†æ</h2>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="refresh-btn" onclick="refreshAnalytics()">ğŸ”„ é‡æ–°æ•´ç†</button>
                                <button class="refresh-btn" onclick="exportAnalytics('csv')">ğŸ“¥ åŒ¯å‡º CSV</button>
                                <button class="refresh-btn" onclick="exportAnalytics('json')">ğŸ“¥ åŒ¯å‡º JSON</button>
                            </div>
                        </div>
                        
                        <div class="analytics-stats-grid">
                            <div class="analytics-stat-card">
                                <h3>è¨ªå•æ™‚é–“åˆ†å¸ƒ</h3>
                                <canvas id="hourDistributionChart"></canvas>
                            </div>
                            <div class="analytics-stat-card">
                                <h3>åœ‹å®¶/åœ°å€è¨ªå•æ’è¡Œ</h3>
                                <div id="pageRankingList"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- éæ¿¾å™¨ç®¡ç† Tab -->
                <div class="tab-panel" id="filters-panel">
                    <div class="filters-container">
                        <div class="filters-header">
                            <h2>å…§å®¹éæ¿¾å™¨ç®¡ç†</h2>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="filterEnabledToggle" checked onchange="toggleFilterEnabled()">
                                    <span>å•Ÿç”¨éæ¿¾å™¨</span>
                                </label>
                                <button class="refresh-btn" onclick="showAddFilterDialog()">â• æ–°å¢éæ¿¾è©</button>
                            </div>
                        </div>
                        
                        <div class="filter-stats">
                            <div class="stat-card">
                                <div class="stat-label">ç¸½æ””æˆªæ¬¡æ•¸</div>
                                <div class="stat-value" id="totalBlocked">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœ€å¾Œæ””æˆªæ™‚é–“</div>
                                <div class="stat-value" id="lastBlocked" style="font-size: 1rem;">å¾æœª</div>
                            </div>
                        </div>
                        
                        <div class="filters-list" id="filtersList">
                            <!-- éæ¿¾è©åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                        </div>

                        <!-- æœ€è¿‘æ””æˆªå…§å®¹ -->
                        <div class="blocked-logs">
                            <div class="blocked-logs-header">
                                <h3>æœ€è¿‘æ””æˆªçš„å…§å®¹ï¼ˆå…¨ç«™ + æœ¬æ©Ÿå‚™ç”¨ï¼‰</h3>
                                <div style="display:flex; gap:0.5rem; flex-wrap: wrap;">
                                    <button class="refresh-btn" onclick="loadBlockedLogs()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                                    <button class="refresh-btn" onclick="clearBlockedLogs()" style="padding: 0.5rem 1rem; font-size: 0.9rem; background: var(--accent);">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
                                </div>
                            </div>
                            <div id="blockedLogsList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- åŠŸèƒ½é–‹é—œ Tab -->
                <div class="tab-panel" id="settings-panel">
                    <div class="settings-container">
                        <h2>åŠŸèƒ½é–‹é—œ</h2>
                        <div class="settings-list">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <h3>æ‚„æ‚„è©±åŠŸèƒ½</h3>
                                    <p>æ§åˆ¶ç”¨æˆ¶æ˜¯å¦å¯ä»¥æäº¤æ‚„æ‚„è©±</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="whisperEnabledToggle" checked onchange="toggleWhisperEnabled()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç³»çµ±è¨­å®š Tab -->
                <div class="tab-panel" id="system-panel">
                    <div class="system-container">
                        <h2>ç³»çµ±è¨­å®š</h2>
                        <div class="system-actions">
                            <button class="refresh-btn" onclick="showChangePasswordDialog()">ğŸ” æ›´æ”¹å¯†ç¢¼</button>
                            <button class="refresh-btn" onclick="clearAnalyticsData()" style="background: var(--accent);">ğŸ—‘ï¸ æ¸…é™¤çµ±è¨ˆæ•¸æ“š</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </section>
    </main>

    <!-- é å°¾ -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; <button type="button" class="year-trigger" data-launch="2025/11/23" aria-label="æŸ¥çœ‹å»ºç«™è³‡è¨Š">2025</button> è€é­š oldfish.</p>
                <p class="footer-note">(æœ¬é é¢ç”±cursorè¼”åŠ©è£½ä½œ)</p>
            </div>
        </div>
    </footer>

    <!-- å³ä¸‹è§’ä¸€éµé‡æ•´ -->
    <button class="admin-fab" type="button" onclick="refreshAll()" aria-label="é‡æ•´æ‰€æœ‰è³‡æ–™" title="é‡æ•´æ‰€æœ‰è³‡æ–™">
        â†»
    </button>

    <script src="analytics.js"></script>
    <script src="filter.js"></script>
    <script src="script.js"></script>
    <script>
        // ============================================
        // å¯†ç¢¼ä¿è­·ï¼ˆä½¿ç”¨é›œæ¹Šï¼‰
        // ============================================
        const PASSWORD_HASH_KEY = 'admin_password_hash';
        const AUTH_KEY = 'admin_authenticated';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24å°æ™‚
        
        // ä½¿ç”¨ SHA-256 é›œæ¹Šå¯†ç¢¼
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼ï¼ˆåƒ…åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ï¼‰
        async function initDefaultPassword() {
            const existingHash = localStorage.getItem(PASSWORD_HASH_KEY);
            if (!existingHash) {
                // é è¨­å¯†ç¢¼ï¼šAndy0228
                const defaultHash = await hashPassword('Andy0228');
                localStorage.setItem(PASSWORD_HASH_KEY, defaultHash);
                console.log('å·²åˆå§‹åŒ–é è¨­å¯†ç¢¼');
            }
        }
        
        // é©—è­‰å¯†ç¢¼
        async function verifyPassword(inputPassword) {
            const storedHash = localStorage.getItem(PASSWORD_HASH_KEY);
            if (!storedHash) {
                await initDefaultPassword();
                return await verifyPassword(inputPassword);
            }
            const inputHash = await hashPassword(inputPassword);
            return inputHash === storedHash;
        }
        
        // æ›´æ”¹å¯†ç¢¼
        async function changePassword(oldPassword, newPassword) {
            const isValid = await verifyPassword(oldPassword);
            if (!isValid) {
                return { success: false, message: 'èˆŠå¯†ç¢¼éŒ¯èª¤' };
            }
            if (newPassword.length < 4) {
                return { success: false, message: 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 4 å€‹å­—å…ƒ' };
            }
            const newHash = await hashPassword(newPassword);
            localStorage.setItem(PASSWORD_HASH_KEY, newHash);
            // æ¸…é™¤ç•¶å‰èªè­‰ï¼Œéœ€è¦é‡æ–°ç™»å…¥
            sessionStorage.removeItem(AUTH_KEY);
            return { success: true, message: 'å¯†ç¢¼å·²æ›´æ”¹ï¼Œè«‹é‡æ–°ç™»å…¥' };
        }
        
        function checkAuth() {
            const authData = sessionStorage.getItem(AUTH_KEY);
            if (authData) {
                const { timestamp, authenticated } = JSON.parse(authData);
                const now = Date.now();
                // æª¢æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆæ™‚é–“å…§ï¼ˆ24å°æ™‚ï¼‰
                if (authenticated && (now - timestamp) < SESSION_DURATION) {
                    return true;
                } else {
                    // éæœŸï¼Œæ¸…é™¤èªè­‰
                    sessionStorage.removeItem(AUTH_KEY);
                }
            }
            return false;
        }
        
        function showPasswordPrompt() {
            // éš±è—ä¸»è¦å…§å®¹
            const mainContent = document.querySelector('.section');
            if (mainContent) {
                mainContent.style.display = 'none';
            }
            
            // å‰µå»ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
            const passwordContainer = document.createElement('div');
            passwordContainer.id = 'passwordContainer';
            passwordContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--bg-main);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            passwordContainer.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 3rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                ">
                    <h2 style="
                        font-size: 2rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 0.5rem;
                    ">ç®¡ç†å¾Œå°</h2>
                    <p style="
                        color: var(--text-secondary);
                        margin-bottom: 2rem;
                    ">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
                    <input type="password" id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" style="
                        width: 100%;
                        padding: 1rem;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        background: var(--bg-main);
                        color: var(--text-primary);
                        font-size: 1rem;
                        margin-bottom: 1rem;
                        font-family: inherit;
                        transition: all 0.3s ease;
                    " autofocus>
                    <div id="errorMessage" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <button id="submitPassword" style="
                        width: 100%;
                        padding: 1rem;
                        background: var(--gradient-primary);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 1.1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">ç¢ºèª</button>
                </div>
            `;
            
            document.body.appendChild(passwordContainer);
            
            const passwordInput = document.getElementById('passwordInput');
            const submitBtn = document.getElementById('submitPassword');
            const errorMsg = document.getElementById('errorMessage');
            
            async function handleSubmit() {
                const password = passwordInput.value.trim();
                if (!password) {
                    errorMsg.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'é©—è­‰ä¸­...';
                
                try {
                    // åˆå§‹åŒ–é è¨­å¯†ç¢¼ï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰
                    await initDefaultPassword();
                    
                    const isValid = await verifyPassword(password);
                    if (isValid) {
                        // èªè­‰æˆåŠŸ
                        const authData = {
                            authenticated: true,
                            timestamp: Date.now()
                        };
                        sessionStorage.setItem(AUTH_KEY, JSON.stringify(authData));
                        passwordContainer.remove();
                        if (mainContent) {
                            mainContent.style.display = '';
                        }
                        // è¼‰å…¥è¨Šæ¯
                        if (typeof loadMessages === 'function') {
                            loadMessages();
                        }
                    } else {
                        // å¯†ç¢¼éŒ¯èª¤
                        errorMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';
                        errorMsg.style.display = 'block';
                        passwordInput.value = '';
                        passwordInput.focus();
                        passwordInput.style.borderColor = '#EF4444';
                        setTimeout(() => {
                            passwordInput.style.borderColor = '';
                        }, 2000);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ç¢ºèª';
                    }
                } catch (error) {
                    console.error('é©—è­‰å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç¢ºèª';
                }
            }
            
            submitBtn.addEventListener('click', handleSubmit);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
            });
        }
        
        // æ›´æ”¹å¯†ç¢¼å°è©±æ¡†
        function showChangePasswordDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'changePasswordDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 2.5rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 450px;
                    width: 90%;
                ">
                    <h3 style="
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 1.5rem;
                    ">æ›´æ”¹å¯†ç¢¼</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">èˆŠå¯†ç¢¼</label>
                        <input type="password" id="oldPasswordInput" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        " autofocus>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPasswordInput" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘4å€‹å­—å…ƒï¼‰" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        ">
                    </div>
                    <div id="changePasswordError" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div id="changePasswordSuccess" style="
                        color: #10B981;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button id="confirmChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--gradient-primary);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">ç¢ºèªæ›´æ”¹</button>
                        <button id="cancelChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--bg-section);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmBtn = document.getElementById('confirmChangePassword');
            const cancelBtn = document.getElementById('cancelChangePassword');
            const errorMsg = document.getElementById('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            
            async function handleChangePassword() {
                const oldPassword = oldPasswordInput.value.trim();
                const newPassword = newPasswordInput.value.trim();
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                if (!oldPassword || !newPassword) {
                    errorMsg.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'è™•ç†ä¸­...';
                
                try {
                    const result = await changePassword(oldPassword, newPassword);
                    if (result.success) {
                        successMsg.textContent = result.message;
                        successMsg.style.display = 'block';
                        setTimeout(() => {
                            dialog.remove();
                            // é‡æ–°é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
                            showPasswordPrompt();
                        }, 2000);
                    } else {
                        errorMsg.textContent = result.message;
                        errorMsg.style.display = 'block';
                        oldPasswordInput.value = '';
                        newPasswordInput.value = '';
                        oldPasswordInput.focus();
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                    }
                } catch (error) {
                    console.error('æ›´æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                }
            }
            
            confirmBtn.addEventListener('click', handleChangePassword);
            cancelBtn.addEventListener('click', () => dialog.remove());
            
            // Enter éµæäº¤
            newPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChangePassword();
                }
            });
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼
        initDefaultPassword();
        
        // æ›´æ”¹å¯†ç¢¼å°è©±æ¡†
        function showChangePasswordDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'changePasswordDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 2.5rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 450px;
                    width: 90%;
                ">
                    <h3 style="
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 1.5rem;
                    ">æ›´æ”¹å¯†ç¢¼</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">èˆŠå¯†ç¢¼</label>
                        <input type="password" id="oldPasswordInput" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        " autofocus>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPasswordInput" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘4å€‹å­—å…ƒï¼‰" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        ">
                    </div>
                    <div id="changePasswordError" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div id="changePasswordSuccess" style="
                        color: #10B981;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button id="confirmChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--gradient-primary);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">ç¢ºèªæ›´æ”¹</button>
                        <button id="cancelChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--bg-section);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmBtn = document.getElementById('confirmChangePassword');
            const cancelBtn = document.getElementById('cancelChangePassword');
            const errorMsg = document.getElementById('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            
            async function handleChangePassword() {
                const oldPassword = oldPasswordInput.value.trim();
                const newPassword = newPasswordInput.value.trim();
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                if (!oldPassword || !newPassword) {
                    errorMsg.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'è™•ç†ä¸­...';
                
                try {
                    const result = await changePassword(oldPassword, newPassword);
                    if (result.success) {
                        successMsg.textContent = result.message;
                        successMsg.style.display = 'block';
                        setTimeout(() => {
                            dialog.remove();
                            // é‡æ–°é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
                            showPasswordPrompt();
                        }, 2000);
                    } else {
                        errorMsg.textContent = result.message;
                        errorMsg.style.display = 'block';
                        oldPasswordInput.value = '';
                        newPasswordInput.value = '';
                        oldPasswordInput.focus();
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                    }
                } catch (error) {
                    console.error('æ›´æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                }
            }
            
            confirmBtn.addEventListener('click', handleChangePassword);
            cancelBtn.addEventListener('click', () => dialog.remove());
            
            // Enter éµæäº¤
            newPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChangePassword();
                }
            });
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼
        initDefaultPassword();
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥èªè­‰
        if (!checkAuth()) {
            // å¦‚æœ DOM å·²è¼‰å…¥ï¼Œç«‹å³é¡¯ç¤ºå¯†ç¢¼æç¤º
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showPasswordPrompt);
            } else {
                showPasswordPrompt();
            }
        }
        
        // è¼‰å…¥è¨Šæ¯
        async function loadMessages() {
            const messagesListEl = document.getElementById('messagesList');
            if (!messagesListEl) {
                console.error('æ‰¾ä¸åˆ° messagesList å…ƒç´ ');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            messagesListEl.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">â³</div>
                    <div class="empty-state-text">è¼‰å…¥ä¸­...</div>
                </div>
            `;
            
            // ä½¿ç”¨ GitHub Issues APIï¼ˆé€šéå¾Œç«¯ä»£ç†ï¼‰
            // è¨­ç½®æ­¥é©Ÿï¼š
            // 1. éƒ¨ç½² api/get-issues.js åˆ° Vercel/Netlify
            // 2. å°‡ä¸‹é¢çš„ API_ENDPOINT æ›¿æ›ç‚ºä½ çš„ API URL
            
            const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-issues'; // æ›¿æ›ç‚ºå¯¦éš›çš„ API URL
            const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
            
            let messages = [];
            
            if (useAPI) {
                try {
                    // å¾ GitHub Issues API è®€å–
                    const response = await fetch(API_ENDPOINT);
                    const data = await response.json();
                    
                    if (data.success && data.messages) {
                        messages = data.messages;
                        console.log('å¾ GitHub Issues è¼‰å…¥è¨Šæ¯æ•¸é‡:', messages.length);
                    } else {
                        throw new Error(data.error || 'è®€å–å¤±æ•—');
                    }
                } catch (error) {
                    console.error('å¾ API è®€å–è¨Šæ¯å¤±æ•—:', error);
                    messagesListEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">ç„¡æ³•è¼‰å…¥è¨Šæ¯</div>
                            <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                éŒ¯èª¤ï¼š${error.message}
                            </div>
                        </div>
                    `;
                    return;
                }
            } else {
                // å‚™ç”¨æ–¹æ¡ˆï¼šå¾ localStorage è®€å–ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰
                console.warn('âš ï¸ API ç«¯é»æœªè¨­ç½®ï¼Œä½¿ç”¨ localStorage ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ');
                
                if (typeof(Storage) === "undefined") {
                    messagesListEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">ç€è¦½å™¨ä¸æ”¯æ´ localStorage</div>
                        </div>
                    `;
                    return;
                }
                
                const rawData = localStorage.getItem('whisperMessages');
                if (rawData) {
                    try {
                        messages = JSON.parse(rawData);
                        if (!Array.isArray(messages)) {
                            messages = [];
                        }
                    } catch (error) {
                        console.error('è§£æè¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        messages = [];
                    }
                }
                
                console.log('å¾ localStorage è¼‰å…¥è¨Šæ¯æ•¸é‡:', messages.length);
            }
            
            // æ›´æ–°çµ±è¨ˆ
            const total = messages.length;
            const unread = messages.filter(m => !m.read).length;
            const read = total - unread;
            
            const totalEl = document.getElementById('totalMessages');
            const unreadEl = document.getElementById('unreadMessages');
            const readEl = document.getElementById('readMessages');
            
            if (totalEl) totalEl.textContent = total;
            if (unreadEl) unreadEl.textContent = unread;
            if (readEl) readEl.textContent = read;
            
            // æ¸…ç©ºåˆ—è¡¨
            messagesListEl.innerHTML = '';
            
            if (messages.length === 0) {
                messagesListEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-text">ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯</div>
                        <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                            æç¤ºï¼šè«‹åœ¨ contact.html æäº¤è¨Šæ¯å¾Œå†ä¾†æŸ¥çœ‹
                        </div>
                    </div>
                `;
                return;
            }
            
            // é¡¯ç¤ºè¨Šæ¯
            messages.forEach((message) => {
                // ç¢ºä¿è¨Šæ¯æœ‰å¿…è¦çš„æ¬„ä½
                if (!message.id || !message.name || !message.message) {
                    console.warn('è¨Šæ¯è³‡æ–™ä¸å®Œæ•´ï¼Œè·³é:', message);
                    return;
                }
                
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${message.read ? '' : 'unread'}`;
                messageItem.id = `message-${message.id}`;
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                let formattedDate = 'æœªçŸ¥æ™‚é–“';
                try {
                    const date = new Date(message.timestamp);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toLocaleString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (e) {
                    console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±æ•—:', e);
                }
                
                // å¦‚æœæœ‰ Issue URLï¼Œæ·»åŠ é€£çµ
                const issueLink = message.issueUrl ? 
                    `<a href="${message.issueUrl}" target="_blank" style="color: var(--primary); text-decoration: none; margin-left: 0.5rem;">#${message.issueNumber}</a>` : 
                    '';
                
                messageItem.style.position = 'relative';
                messageItem.style.paddingLeft = '3rem';
                
                messageItem.innerHTML = `
                    <input type="checkbox" style="position: absolute; top: 1rem; left: 1rem; width: 20px; height: 20px; cursor: pointer; z-index: 10;" onchange="handleMessageCheckbox(this, ${message.id})">
                    <div class="message-header">
                        <div class="message-info">
                            <div class="message-name">${escapeHtml(message.name || 'æœªæä¾›')}${issueLink}</div>
                        </div>
                        <div class="message-time">${formattedDate}</div>
                    </div>
                    <div class="message-content">${escapeHtml(message.message || '')}</div>
                    <div class="message-actions">
                        ${!message.read ? `<button class="btn-action btn-mark-read" onclick="markAsRead(${message.id})">æ¨™è¨˜ç‚ºå·²è®€</button>` : ''}
                        <button class="btn-action btn-delete" onclick="deleteMessage(${message.id})">åˆªé™¤</button>
                        ${message.issueUrl ? `<a href="${message.issueUrl}" target="_blank" class="btn-action" style="background: var(--bg-section); color: var(--text-primary); text-decoration: none; display: inline-block;">åœ¨ GitHub æŸ¥çœ‹</a>` : ''}
                    </div>
                `;
                
                messagesListEl.appendChild(messageItem);
            });
        }
        
        // æ¨™è¨˜ç‚ºå·²è®€ï¼ˆé—œé–‰ GitHub Issueï¼‰
        async function markAsRead(id) {
            try {
                const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-issues';
                const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
                
                if (useAPI && typeof id === 'number' && id > 0) {
                    // ä½¿ç”¨ GitHub Issues API é—œé–‰ Issue
                    const closeApiEndpoint = 'https://oldfish-profile.vercel.app/api/close-issue';
                    
                    const response = await fetch(closeApiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            issueNumber: id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // æˆåŠŸé—œé–‰ Issueï¼Œé‡æ–°è¼‰å…¥è¨Šæ¯
                        loadMessages();
                    } else {
                        throw new Error(data.error || 'é—œé–‰ Issue å¤±æ•—');
                    }
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ localStorageï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰
                    const rawData = localStorage.getItem('whisperMessages');
                    if (rawData) {
                        let messages = JSON.parse(rawData);
                        if (Array.isArray(messages)) {
                            const message = messages.find(m => m.id === id);
                            if (message) {
                                message.read = true;
                                localStorage.setItem('whisperMessages', JSON.stringify(messages));
                            }
                        }
                    }
                    
                    // é‡æ–°è¼‰å…¥è¨Šæ¯
                    loadMessages();
                }
            } catch (error) {
                console.error('æ¨™è¨˜ç‚ºå·²è®€æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('æ“ä½œå¤±æ•—ï¼š' + (error.message || 'è«‹é‡è©¦'));
            }
        }
        
        // åˆªé™¤è¨Šæ¯ï¼ˆçœŸæ­£åˆªé™¤ GitHub Issueï¼‰
        async function deleteMessage(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡è¨Šæ¯å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }
            
            try {
                const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-issues';
                const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
                
                if (useAPI && typeof id === 'number' && id > 0) {
                    // ä½¿ç”¨ GitHub Issues API çœŸæ­£åˆªé™¤ Issueï¼ˆé—œé–‰ä¸¦æ¸…ç©ºå…§å®¹ï¼‰
                    const deleteApiEndpoint = 'https://oldfish-profile.vercel.app/api/delete-issue';
                    
                    let response;
                    try {
                        response = await fetch(deleteApiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                issueNumber: id
                            })
                        });
                    } catch (fetchError) {
                        // å¦‚æœ fetch å¤±æ•—ï¼ˆAPI ä¸å­˜åœ¨æˆ–ç¶²è·¯å•é¡Œï¼‰ï¼Œå›é€€åˆ°é—œé–‰ Issue
                        console.warn('åˆªé™¤ API ä¸å¯ç”¨ï¼Œå›é€€åˆ°é—œé–‰ Issue:', fetchError);
                        const closeApiEndpoint = 'https://oldfish-profile.vercel.app/api/close-issue';
                        response = await fetch(closeApiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                issueNumber: id
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                alert('æ³¨æ„ï¼šåˆªé™¤ API å°šæœªéƒ¨ç½²ï¼Œå·²æ”¹ç‚ºé—œé–‰ Issueã€‚è«‹éƒ¨ç½² api/delete-issue.js ä»¥å•Ÿç”¨å®Œæ•´åˆªé™¤åŠŸèƒ½ã€‚');
                                loadMessages();
                                return;
                            }
                        }
                        throw new Error('ç„¡æ³•é€£æ¥åˆ° API ä¼ºæœå™¨ï¼Œè«‹ç¢ºèª API å·²æ­£ç¢ºéƒ¨ç½²');
                    }
                    
                    if (!response.ok) {
                        // å¦‚æœåˆªé™¤ API è¿”å›éŒ¯èª¤ï¼Œå˜—è©¦å›é€€åˆ°é—œé–‰ Issue
                        if (response.status === 404) {
                            console.warn('åˆªé™¤ API ä¸å­˜åœ¨ï¼Œå›é€€åˆ°é—œé–‰ Issue');
                            const closeApiEndpoint = 'https://oldfish-profile.vercel.app/api/close-issue';
                            const fallbackResponse = await fetch(closeApiEndpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    issueNumber: id
                                })
                            });
                            
                            if (fallbackResponse.ok) {
                                const data = await fallbackResponse.json();
                                if (data.success) {
                                    alert('æ³¨æ„ï¼šåˆªé™¤ API å°šæœªéƒ¨ç½²ï¼Œå·²æ”¹ç‚ºé—œé–‰ Issueã€‚è«‹éƒ¨ç½² api/delete-issue.js ä»¥å•Ÿç”¨å®Œæ•´åˆªé™¤åŠŸèƒ½ã€‚');
                                    loadMessages();
                                    return;
                                }
                            }
                        }
                        const errorData = await response.json().catch(() => ({ error: 'æœªçŸ¥éŒ¯èª¤' }));
                        throw new Error(errorData.error || 'åˆªé™¤å¤±æ•—');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // æˆåŠŸåˆªé™¤ Issueï¼Œé‡æ–°è¼‰å…¥è¨Šæ¯
                        loadMessages();
                    } else {
                        throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                    }
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ localStorageï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰
                    const rawData = localStorage.getItem('whisperMessages');
                    if (rawData) {
                        let messages = JSON.parse(rawData);
                        if (Array.isArray(messages)) {
                            messages = messages.filter(m => m.id !== id);
                            localStorage.setItem('whisperMessages', JSON.stringify(messages));
                        }
                    }
                    
                    // é‡æ–°è¼‰å…¥è¨Šæ¯
                    loadMessages();
                }
            } catch (error) {
                console.error('åˆªé™¤è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + (error.message || 'è«‹é‡è©¦'));
            }
        }
        
        // HTML è½‰ç¾©ï¼ˆé˜²æ­¢ XSSï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // é é¢è¼‰å…¥æ™‚è¼‰å…¥è¨Šæ¯
        function initAdmin() {
            console.log('ç®¡ç†å¾Œå°é é¢å·²è¼‰å…¥');
            try {
                loadMessages();
            } catch (error) {
                console.error('è¼‰å…¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                const messagesList = document.getElementById('messagesList');
                if (messagesList) {
                    messagesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">è¼‰å…¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤</div>
                            <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                éŒ¯èª¤ï¼š${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAdmin);
        } else {
            // å¦‚æœ DOM å·²è¼‰å…¥ï¼Œç¨ç­‰ä¸€ä¸‹ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“
            setTimeout(initAdmin, 100);
        }
        
        // æ·»åŠ èª¿è©¦åŠŸèƒ½ï¼šåœ¨æ§åˆ¶å°é¡¯ç¤ºæ‰€æœ‰è¨Šæ¯
        window.debugMessages = function() {
            const messages = JSON.parse(localStorage.getItem('whisperMessages') || '[]');
            console.table(messages);
            console.log('è¨Šæ¯æ•¸é‡:', messages.length);
            return messages;
        };
        
        // æ‰‹å‹•é‡æ–°è¼‰å…¥è¨Šæ¯
        window.reloadMessages = function() {
            console.log('æ‰‹å‹•é‡æ–°è¼‰å…¥è¨Šæ¯');
            loadMessages();
        };
        
        console.log('æç¤ºï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ debugMessages() å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è¨Šæ¯');
        console.log('æç¤ºï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ reloadMessages() å¯ä»¥é‡æ–°è¼‰å…¥è¨Šæ¯');
        
        // ============================================
        // Tab åˆ‡æ›åŠŸèƒ½
        // ============================================
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                // æ›´æ–° Tab æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // æ›´æ–° Tab é¢æ¿é¡¯ç¤º
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                const targetPanel = document.getElementById(`${targetTab}-panel`);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                    
                    // æ ¹æ“š Tab è¼‰å…¥ç›¸æ‡‰æ•¸æ“š
                    if (targetTab === 'dashboard') {
                        loadDashboard();
                    } else if (targetTab === 'analytics') {
                        loadAnalytics();
                    } else if (targetTab === 'filters') {
                        loadFilters();
                    } else if (targetTab === 'settings') {
                        loadSettings();
                    }
                }
            });
        });
        
        // ============================================
        // å„€è¡¨æ¿åŠŸèƒ½
        // ============================================
        let viewsChart = null;
        let pagesChart = null;
        let countryChart = null;
        
        async function loadDashboard() {
            const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-visits';
            const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
            
            let stats = null;
            let visits = [];
            
            if (useAPI) {
                try {
                    // å¾å¾Œç«¯ API ç²å–çœŸå¯¦çš„è¨ªå•çµ±è¨ˆ
                    const response = await fetch(API_ENDPOINT);
                    const data = await response.json();
                    
                    if (data.success) {
                        stats = {
                            totalViews: data.totalViews || 0,
                            todayViews: data.todayViews || 0,
                            weekViews: data.weekViews || 0,
                            monthViews: data.monthViews || 0,
                            pageViews: data.pageViews || {},
                            dailyViews: data.dailyViews || {},
                            countryStats: data.countryStats || {}
                        };
                        visits = data.visits || [];
                    } else {
                        throw new Error(data.error || 'ç²å–çµ±è¨ˆå¤±æ•—');
                    }
                } catch (error) {
                    console.warn('å¾ API ç²å–çµ±è¨ˆå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š:', error);
                    // å›é€€åˆ°æœ¬åœ°çµ±è¨ˆ
                    if (typeof Analytics !== 'undefined') {
                        stats = Analytics.getStats();
                    }
                }
            } else {
                // ä½¿ç”¨æœ¬åœ°çµ±è¨ˆï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
                if (typeof Analytics !== 'undefined') {
                    stats = Analytics.getStats();
                }
            }
            
            if (!stats) {
                console.error('ç„¡æ³•ç²å–çµ±è¨ˆæ•¸æ“š');
                return;
            }
            
            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            document.getElementById('totalViews').textContent = stats.totalViews.toLocaleString();
            document.getElementById('todayViews').textContent = stats.todayViews.toLocaleString();
            document.getElementById('weekViews').textContent = stats.weekViews.toLocaleString();
            document.getElementById('monthViews').textContent = stats.monthViews.toLocaleString();
            
            // è¼‰å…¥åœ–è¡¨
            loadViewsChart(stats.dailyViews);
            loadPagesChart(stats.pageViews);
            loadCountryChart(stats.countryStats);
        }
        
        function loadViewsChart(dailyViews) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªè¼‰å…¥');
                return;
            }
            
            const ctx = document.getElementById('viewsChart');
            if (!ctx) return;
            
            // æº–å‚™æœ€è¿‘ 30 å¤©çš„æ•¸æ“š
            const today = new Date();
            const dailyData = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dailyData.push({
                    date: dateStr,
                    views: dailyViews[dateStr] || 0
                });
            }
            
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
            const isDark = theme === 'dark';
            
            const chartColors = {
                border: isDark ? 'rgba(59, 130, 246, 1)' : 'rgba(37, 99, 235, 1)',
                background: isDark ? 'rgba(59, 130, 246, 0.1)' : 'rgba(37, 99, 235, 0.1)'
            };
            
            if (viewsChart) {
                viewsChart.destroy();
            }
            
            viewsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => d.date.split('-')[1] + '/' + d.date.split('-')[2]),
                    datasets: [{
                        label: 'ç€è¦½é‡',
                        data: dailyData.map(d => d.views),
                        borderColor: chartColors.border,
                        backgroundColor: chartColors.background,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: isDark ? '#CBD5E1' : '#475569'
                            },
                            grid: {
                                color: isDark ? 'rgba(51, 65, 85, 0.5)' : 'rgba(226, 232, 240, 0.5)'
                            }
                        },
                        x: {
                            ticks: {
                                color: isDark ? '#CBD5E1' : '#475569'
                            },
                            grid: {
                                color: isDark ? 'rgba(51, 65, 85, 0.5)' : 'rgba(226, 232, 240, 0.5)'
                            }
                        }
                    }
                }
            });
        }
        
        function loadPagesChart(pageViews) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªè¼‰å…¥');
                return;
            }
            
            const ctx = document.getElementById('pagesChart');
            if (!ctx) return;
            
            const sortedPages = Object.entries(pageViews || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sortedPages.length === 0) {
                ctx.parentElement.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">æš«ç„¡æ•¸æ“š</p>';
                return;
            }
            
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
            const isDark = theme === 'dark';
            
            const colors = [
                'rgba(59, 130, 246, 0.8)',
                'rgba(6, 182, 212, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(236, 72, 153, 0.8)',
                'rgba(251, 146, 60, 0.8)'
            ];
            
            if (pagesChart) {
                pagesChart.destroy();
            }
            
            pagesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedPages.map(([page]) => {
                        if (page === '/' || page === '/index.html') return 'é¦–é ';
                        const pageName = page.split('/').pop().replace('.html', '');
                        return pageName || page;
                    }),
                    datasets: [{
                        data: sortedPages.map(([, views]) => views),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: isDark ? '#CBD5E1' : '#475569',
                                padding: 15
                            }
                        }
                    }
                }
            });
        }
        
        // ============================================
        // ç¶²ç«™çµ±è¨ˆåŠŸèƒ½
        // ============================================
        let hourChart = null;
        
        async function loadAnalytics() {
            const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-visits';
            const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;
            
            let stats = null;
            
            if (useAPI) {
                try {
                    // å¾å¾Œç«¯ API ç²å–çœŸå¯¦çš„è¨ªå•çµ±è¨ˆ
                    const response = await fetch(API_ENDPOINT);
                    const data = await response.json();
                    
                    if (data.success) {
                        stats = {
                            pageViews: data.pageViews || {},
                            countryStats: data.countryStats || {},
                            visits: data.visits || []
                        };
                    } else {
                        throw new Error(data.error || 'ç²å–çµ±è¨ˆå¤±æ•—');
                    }
                } catch (error) {
                    console.warn('å¾ API ç²å–çµ±è¨ˆå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š:', error);
                    // å›é€€åˆ°æœ¬åœ°çµ±è¨ˆ
                    if (typeof Analytics !== 'undefined') {
                        const localStats = Analytics.getStats();
                        stats = {
                            pageViews: localStats.pageViews || {},
                            countryStats: {},
                            visits: []
                        };
                    }
                }
            } else {
                // ä½¿ç”¨æœ¬åœ°çµ±è¨ˆï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
                if (typeof Analytics !== 'undefined') {
                    const localStats = Analytics.getStats();
                    stats = {
                        pageViews: localStats.pageViews || {},
                        countryStats: {},
                        visits: []
                    };
                }
            }
            
            if (!stats) {
                console.error('ç„¡æ³•ç²å–çµ±è¨ˆæ•¸æ“š');
                return;
            }
            
            // è¼‰å…¥è¨ªå•æ™‚é–“åˆ†å¸ƒåœ–ï¼ˆç”¨å‰ç«¯æœ¬åœ°æ™‚å€è¨ˆç®—ï¼Œé¿å… UTC åç§»ï¼‰
            loadHourDistributionChartFromVisits(stats.visits);
            
            // è¼‰å…¥é é¢æ’è¡Œ
            loadPageRanking(stats.pageViews);
            
            // è¼‰å…¥åœ‹å®¶/åœ°å€çµ±è¨ˆ
            loadCountryRanking(stats.countryStats);
        }

        function loadHourDistributionChartFromVisits(visits) {
            const hourDistribution = {};
            for (let i = 0; i < 24; i++) hourDistribution[i] = 0;
            (visits || []).forEach(v => {
                try {
                    const d = new Date(v.timestamp);
                    const h = d.getHours(); // ç”±ç€è¦½å™¨æœ¬åœ°æ™‚å€æ±ºå®š
                    hourDistribution[h] = (hourDistribution[h] || 0) + 1;
                } catch (e) {}
            });
            loadHourDistributionChart(hourDistribution);
        }
        
        function loadCountryRanking(countryStats) {
            const listEl = document.getElementById('pageRankingList');
            if (!listEl) return;
            
            const sortedCountries = Object.entries(countryStats || {})
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (sortedCountries.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">æš«ç„¡æ•¸æ“š</p>';
                return;
            }
            
            // æ›´æ–°æ¨™é¡Œ
            const titleEl = listEl.previousElementSibling;
            if (titleEl && titleEl.tagName === 'H3') {
                titleEl.textContent = 'åœ‹å®¶/åœ°å€è¨ªå•æ’è¡Œ';
            }
            
            listEl.innerHTML = sortedCountries.map(([country, views], index) => {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg-card); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-weight: 600; color: var(--primary); width: 24px; text-align: center;">${index + 1}</span>
                            <span style="color: var(--text-primary);">${country}</span>
                        </div>
                        <span style="color: var(--text-secondary); font-weight: 600;">${views.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
        }
        
        function loadHourDistributionChart(hourDistribution) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js æœªè¼‰å…¥');
                return;
            }
            
            const ctx = document.getElementById('hourDistributionChart');
            if (!ctx) return;
            
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
            const isDark = theme === 'dark';
            
            const hours = Array.from({ length: 24 }, (_, i) => i);
            const views = hours.map(h => hourDistribution[h] || 0);
            
            if (hourChart) {
                hourChart.destroy();
            }
            
            hourChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => h + ':00'),
                    datasets: [{
                        label: 'è¨ªå•é‡',
                        data: views,
                        backgroundColor: isDark ? 'rgba(59, 130, 246, 0.6)' : 'rgba(37, 99, 235, 0.6)',
                        borderColor: isDark ? 'rgba(59, 130, 246, 1)' : 'rgba(37, 99, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: isDark ? '#CBD5E1' : '#475569'
                            },
                            grid: {
                                color: isDark ? 'rgba(51, 65, 85, 0.5)' : 'rgba(226, 232, 240, 0.5)'
                            }
                        },
                        x: {
                            ticks: {
                                color: isDark ? '#CBD5E1' : '#475569'
                            },
                            grid: {
                                color: isDark ? 'rgba(51, 65, 85, 0.5)' : 'rgba(226, 232, 240, 0.5)'
                            }
                        }
                    }
                }
            });
        }
        
        function loadPageRanking(pageViews) {
            // é€™å€‹å‡½æ•¸ç¾åœ¨ç”¨æ–¼è¼‰å…¥åœ‹å®¶/åœ°å€æ’è¡Œï¼Œé é¢æ’è¡Œå·²åœ¨ loadCountryRanking ä¸­è™•ç†
            // ä¿ç•™æ­¤å‡½æ•¸ä»¥å‚™æœªä¾†æ“´å±•
        }
        
        function refreshAnalytics() {
            loadAnalytics();
        }

        // å³ä¸‹è§’ä¸€éµé‡æ•´ï¼ˆå…¨éƒ¨è³‡æ–™ï¼‰
        function refreshAll() {
            try { loadDashboard(); } catch(e) {}
            try { loadMessages(); } catch(e) {}
            try { loadAnalytics(); } catch(e) {}
            try { loadFilters(); } catch(e) {}
            try { loadSettings(); } catch(e) {}
        }
        
        function exportAnalytics(format) {
            if (typeof Analytics === 'undefined') {
                alert('Analytics æœªè¼‰å…¥');
                return;
            }
            
            let data, filename, mimeType;
            
            if (format === 'csv') {
                data = Analytics.exportToCSV();
                filename = `analytics_${new Date().toISOString().split('T')[0]}.csv`;
                mimeType = 'text/csv';
            } else {
                data = Analytics.exportToJSON();
                filename = `analytics_${new Date().toISOString().split('T')[0]}.json`;
                mimeType = 'application/json';
            }
            
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ============================================
        // éæ¿¾å™¨ç®¡ç†åŠŸèƒ½
        // ============================================
        async function loadFilters() {
            const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-config';
            
            try {
                const response = await fetch(API_ENDPOINT);
                if (!response.ok) throw new Error('Failed to fetch config');
                
                const data = await response.json();
                if (!data.success || !data.config) {
                    throw new Error('Invalid config data');
                }
                
                const config = data.config;
                const filters = Array.isArray(config.filters) ? config.filters : [];
                
                // æ›´æ–°çµ±è¨ˆï¼ˆå¾æ””æˆªè¨˜éŒ„çµ±è¨ˆï¼‰
                const stats = typeof ContentFilter !== 'undefined' ? ContentFilter.getStats() : { totalBlocked: 0, lastBlocked: null };
                document.getElementById('totalBlocked').textContent = stats.totalBlocked.toLocaleString();
                const lastBlocked = stats.lastBlocked;
                if (lastBlocked) {
                    const date = new Date(lastBlocked);
                    document.getElementById('lastBlocked').textContent = date.toLocaleString('zh-TW');
                } else {
                    document.getElementById('lastBlocked').textContent = 'å¾æœª';
                }
                
                // æ›´æ–°é–‹é—œç‹€æ…‹
                document.getElementById('filterEnabledToggle').checked = config.filterEnabled !== false;
                
                // è¼‰å…¥éæ¿¾è©åˆ—è¡¨
                const listEl = document.getElementById('filtersList');
                if (!listEl) return;
                
                if (filters.length === 0) {
                    listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">æš«ç„¡éæ¿¾è©</p>';
                } else {
                    listEl.innerHTML = filters.map(filter => `
                        <div class="filter-item">
                            <div class="filter-item-info">
                                <div class="filter-item-word">${escapeHtml(filter.word)}</div>
                                <div class="filter-item-category">åˆ†é¡ï¼š${escapeHtml(filter.category)}</div>
                            </div>
                            <div class="filter-item-actions">
                                <button class="refresh-btn" onclick="editFilter(${filter.id})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">âœï¸ ç·¨è¼¯</button>
                                <button class="refresh-btn" onclick="removeFilter(${filter.id})" style="padding: 0.5rem 1rem; font-size: 0.9rem; background: var(--accent);">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                        </div>
                    `).join('');
                }

                // åŒæ­¥è¼‰å…¥æ””æˆªå…§å®¹
                loadBlockedLogs();
            } catch (error) {
                console.error('è¼‰å…¥éæ¿¾å™¨è¨­å®šå¤±æ•—:', error);
                const listEl = document.getElementById('filtersList');
                if (listEl) {
                    listEl.innerHTML = '<p style="color: var(--text-error); text-align: center; padding: 2rem;">è¼‰å…¥å¤±æ•—ï¼š' + escapeHtml(error.message) + '</p>';
                }
            }
        }

        function loadBlockedLogs() {
            const list = document.getElementById('blockedLogsList');
            if (!list) return;
            // å…ˆé¡¯ç¤ºè¼‰å…¥ä¸­
            list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1.5rem;">è¼‰å…¥ä¸­...</p>';

            const API_ENDPOINT = 'https://oldfish-profile.vercel.app/api/get-blocked';
            const useAPI = API_ENDPOINT.includes('YOUR_API_URL') === false;

            const render = (items) => {
                if (!items || !items.length) {
                    list.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 1.5rem;">ç›®å‰æ²’æœ‰ä»»ä½•æ””æˆªè¨˜éŒ„</p>`;
                    return;
                }

                list.innerHTML = items.slice(0, 50).map(item => {
                    let timeText = 'æœªçŸ¥æ™‚é–“';
                    try { timeText = new Date(item.timestamp).toLocaleString('zh-TW'); } catch(e) {}

                    const words = item.matches
                        ? (item.matches || []).map(m => m.word).filter(Boolean)
                        : String(item.words || '').split('ã€').map(s => s.trim()).filter(Boolean);
                    const wordTags = words.length ? words.map(w => `<span class="blocked-tag">${escapeHtml(w)}</span>`).join('') : '<span class="blocked-tag">æœªçŸ¥</span>';
                    const nameLine = item.name ? `å§“åï¼š${item.name}` : 'å§“åï¼šæœªæä¾›';
                    const msg = item.message || '';
                    const country = item.country ? `ã€€Â·ã€€${item.country}` : '';

                    return `
                        <div class="blocked-log-item">
                            <div class="blocked-log-meta">
                                <div class="left">${escapeHtml(nameLine)}ã€€Â·ã€€é é¢ï¼š${escapeHtml(item.page || item.path || '/')} ${escapeHtml(country)}</div>
                                <div class="right">${escapeHtml(timeText)}</div>
                            </div>
                            <div class="blocked-log-tags">${wordTags}</div>
                            <div class="blocked-log-content">
                                <details>
                                    <summary>æŸ¥çœ‹è¢«æ””æˆªçš„è¨Šæ¯å…§å®¹</summary>
                                    <pre>${escapeHtml(msg)}</pre>
                                </details>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            if (useAPI) {
                fetch(API_ENDPOINT)
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.success && Array.isArray(data.logs)) {
                            render(data.logs);
                        } else {
                            throw new Error(data?.error || 'API è®€å–å¤±æ•—');
                        }
                    })
                    .catch(() => {
                        list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1.5rem;">ç„¡æ³•å¾ä¼ºæœå™¨è¼‰å…¥æ””æˆªè¨˜éŒ„ï¼Œè«‹ç¢ºèªå·²åœ¨ Vercel è¨­å®š GITHUB_TOKEN ä¸¦é‡æ–°éƒ¨ç½²ã€‚</p>';
                    });
            } else {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1.5rem;">ä¼ºæœå™¨ç«¯ URL å°šæœªè¨­å®šå®Œæ•´ï¼Œè«‹ç¢ºèª /api/get-blocked å·²éƒ¨ç½²ã€‚</p>';
            }
        }

        function clearBlockedLogs() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿçš„æ””æˆªè¨˜éŒ„å—ï¼Ÿ')) return;
            if (typeof ContentFilter !== 'undefined' && typeof ContentFilter.clearBlockedLogs === 'function') {
                ContentFilter.clearBlockedLogs();
            }
            loadBlockedLogs();
        }
        
        async function toggleFilterEnabled() {
            const enabled = document.getElementById('filterEnabledToggle').checked;
            await updateConfig({ filterEnabled: enabled });
            alert(enabled ? 'éæ¿¾å™¨å·²å•Ÿç”¨ï¼ˆå…¨ç«™ç”Ÿæ•ˆï¼‰' : 'éæ¿¾å™¨å·²é—œé–‰ï¼ˆå…¨ç«™ç”Ÿæ•ˆï¼‰');
        }
        
        async function showAddFilterDialog() {
            const word = prompt('è«‹è¼¸å…¥è¦éæ¿¾çš„è©èªï¼š');
            if (!word || !word.trim()) return;
            
            const category = prompt('è«‹è¼¸å…¥åˆ†é¡ï¼ˆspam/fraud/generalï¼‰ï¼š', 'general');
            
            try {
                // å…ˆç²å–ç•¶å‰é…ç½®
                const response = await fetch('https://oldfish-profile.vercel.app/api/get-config');
                const data = await response.json();
                if (!data.success || !data.config) throw new Error('ç„¡æ³•ç²å–ç•¶å‰é…ç½®');
                
                const config = data.config;
                const filters = Array.isArray(config.filters) ? config.filters : [];
                
                // æ·»åŠ æ–°éæ¿¾è©
                const newId = filters.length > 0 ? Math.max(...filters.map(f => f.id)) + 1 : 1;
                filters.push({
                    id: newId,
                    word: word.trim(),
                    category: (category.trim() || 'general'),
                    enabled: true
                });
                
                // æ›´æ–°é…ç½®
                await updateConfig({ filters: filters });
                loadFilters();
            } catch (error) {
                console.error('æ·»åŠ éæ¿¾è©å¤±æ•—:', error);
                alert('æ·»åŠ å¤±æ•—ï¼š' + error.message);
            }
        }
        
        async function editFilter(id) {
            try {
                // å…ˆç²å–ç•¶å‰é…ç½®
                const response = await fetch('https://oldfish-profile.vercel.app/api/get-config');
                const data = await response.json();
                if (!data.success || !data.config) throw new Error('ç„¡æ³•ç²å–ç•¶å‰é…ç½®');
                
                const config = data.config;
                const filters = Array.isArray(config.filters) ? config.filters : [];
                const filter = filters.find(f => f.id === id);
                if (!filter) {
                    alert('æ‰¾ä¸åˆ°è©²éæ¿¾è©');
                    return;
                }
                
                const newWord = prompt('è«‹è¼¸å…¥æ–°çš„éæ¿¾è©ï¼š', filter.word);
                if (!newWord || !newWord.trim()) return;
                
                const newCategory = prompt('è«‹è¼¸å…¥æ–°çš„åˆ†é¡ï¼š', filter.category);
                
                // æ›´æ–°éæ¿¾è©
                const index = filters.findIndex(f => f.id === id);
                if (index !== -1) {
                    filters[index] = {
                        ...filters[index],
                        word: newWord.trim(),
                        category: (newCategory.trim() || filter.category)
                    };
                    
                    // æ›´æ–°é…ç½®
                    await updateConfig({ filters: filters });
                    loadFilters();
                }
            } catch (error) {
                console.error('ç·¨è¼¯éæ¿¾è©å¤±æ•—:', error);
                alert('ç·¨è¼¯å¤±æ•—ï¼š' + error.message);
            }
        }
        
        async function removeFilter(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹éæ¿¾è©å—ï¼Ÿ')) return;
            
            try {
                // å…ˆç²å–ç•¶å‰é…ç½®
                const response = await fetch('https://oldfish-profile.vercel.app/api/get-config');
                const data = await response.json();
                if (!data.success || !data.config) throw new Error('ç„¡æ³•ç²å–ç•¶å‰é…ç½®');
                
                const config = data.config;
                const filters = Array.isArray(config.filters) ? config.filters : [];
                const filtered = filters.filter(f => f.id !== id);
                
                if (filtered.length === filters.length) {
                    alert('æ‰¾ä¸åˆ°è©²éæ¿¾è©');
                    return;
                }
                
                // æ›´æ–°é…ç½®
                await updateConfig({ filters: filtered });
                loadFilters();
            } catch (error) {
                console.error('åˆªé™¤éæ¿¾è©å¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // æ›´æ–°é…ç½®çš„é€šç”¨å‡½æ•¸
        async function updateConfig(updates) {
            try {
                // å…ˆç²å–ç•¶å‰é…ç½®
                const response = await fetch('https://oldfish-profile.vercel.app/api/get-config');
                const data = await response.json();
                if (!data.success || !data.config) throw new Error('ç„¡æ³•ç²å–ç•¶å‰é…ç½®');
                
                const currentConfig = data.config;
                const newConfig = { ...currentConfig, ...updates };
                
                // ç™¼é€æ›´æ–°è«‹æ±‚
                const updateResponse = await fetch('https://oldfish-profile.vercel.app/api/update-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newConfig)
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json().catch(() => ({}));
                    throw new Error(errorData.error || 'æ›´æ–°å¤±æ•—');
                }
                
                const updateData = await updateResponse.json();
                if (!updateData.success) {
                    throw new Error(updateData.error || 'æ›´æ–°å¤±æ•—');
                }
                
                // æ¸…é™¤ç·©å­˜ï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥
                if (typeof ContentFilter !== 'undefined' && ContentFilter.clearCache) {
                    ContentFilter.clearCache();
                }
                if (typeof ConfigManager !== 'undefined' && ConfigManager.clearCache) {
                    ConfigManager.clearCache();
                }
                
                return updateData;
            } catch (error) {
                console.error('æ›´æ–°é…ç½®å¤±æ•—:', error);
                throw error;
            }
        }
        
        // ============================================
        // åŠŸèƒ½é–‹é—œåŠŸèƒ½
        // ============================================
        async function loadSettings() {
            try {
                const response = await fetch('https://oldfish-profile.vercel.app/api/get-config');
                if (!response.ok) throw new Error('Failed to fetch config');
                
                const data = await response.json();
                if (data.success && data.config) {
                    const toggle = document.getElementById('whisperEnabledToggle');
                    if (toggle) {
                        toggle.checked = data.config.whisperEnabled !== false;
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥åŠŸèƒ½é–‹é—œå¤±æ•—:', error);
                // å‡ºéŒ¯æ™‚é è¨­å•Ÿç”¨
                const toggle = document.getElementById('whisperEnabledToggle');
                if (toggle) {
                    toggle.checked = true;
                }
            }
        }
        
        async function toggleWhisperEnabled() {
            const enabled = document.getElementById('whisperEnabledToggle').checked;
            try {
                await updateConfig({ whisperEnabled: enabled });
                alert(enabled ? 'æ‚„æ‚„è©±åŠŸèƒ½å·²å•Ÿç”¨ï¼ˆå…¨ç«™ç”Ÿæ•ˆï¼‰' : 'æ‚„æ‚„è©±åŠŸèƒ½å·²é—œé–‰ï¼ˆå…¨ç«™ç”Ÿæ•ˆï¼‰');
            } catch (error) {
                console.error('æ›´æ–°åŠŸèƒ½é–‹é—œå¤±æ•—:', error);
                alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
                // æ¢å¾©åŸç‹€æ…‹
                document.getElementById('whisperEnabledToggle').checked = !enabled;
            }
        }
        
        // ============================================
        // æ‰¹é‡æ“ä½œåŠŸèƒ½
        // ============================================
        let selectedMessages = new Set();
        
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.message-item input[type="checkbox"]');
            const allSelected = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allSelected;
                const messageId = parseInt(cb.closest('.message-item').id.replace('message-', ''));
                if (!allSelected) {
                    selectedMessages.add(messageId);
                    cb.closest('.message-item').classList.add('selected');
                } else {
                    selectedMessages.delete(messageId);
                    cb.closest('.message-item').classList.remove('selected');
                }
            });
            
            updateBulkButtons();
        }
        
        function updateBulkButtons() {
            const hasSelection = selectedMessages.size > 0;
            document.getElementById('bulkMarkReadBtn').style.display = hasSelection ? 'inline-block' : 'none';
            document.getElementById('bulkDeleteBtn').style.display = hasSelection ? 'inline-block' : 'none';
        }
        
        function bulkMarkAsRead() {
            if (selectedMessages.size === 0) return;
            if (!confirm(`ç¢ºå®šè¦æ¨™è¨˜ ${selectedMessages.size} å‰‡è¨Šæ¯ç‚ºå·²è®€å—ï¼Ÿ`)) return;
            
            selectedMessages.forEach(id => {
                markAsRead(id);
            });
            
            selectedMessages.clear();
            updateBulkButtons();
            setTimeout(() => loadMessages(), 1000);
        }
        
        function bulkDelete() {
            if (selectedMessages.size === 0) return;
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedMessages.size} å‰‡è¨Šæ¯å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;
            
            selectedMessages.forEach(id => {
                deleteMessage(id);
            });
            
            selectedMessages.clear();
            updateBulkButtons();
            setTimeout(() => loadMessages(), 1000);
        }
        
        // è™•ç†è¨Šæ¯è¤‡é¸æ¡†
        function handleMessageCheckbox(checkbox, messageId) {
            if (checkbox.checked) {
                selectedMessages.add(messageId);
                checkbox.closest('.message-item').classList.add('selected');
            } else {
                selectedMessages.delete(messageId);
                checkbox.closest('.message-item').classList.remove('selected');
            }
            updateBulkButtons();
        }
        
        // ============================================
        // ç³»çµ±è¨­å®šåŠŸèƒ½
        // ============================================
        function clearAnalyticsData() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
            
            if (typeof Analytics === 'undefined') {
                alert('Analytics æœªè¼‰å…¥');
                return;
            }
            
            Analytics.reset();
            alert('çµ±è¨ˆæ•¸æ“šå·²æ¸…é™¤');
            if (document.querySelector('.admin-tab[data-tab="dashboard"]').classList.contains('active')) {
                loadDashboard();
            }
        }
        
        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadSettings();
                if (document.querySelector('.admin-tab.active')?.dataset.tab === 'dashboard') {
                    loadDashboard();
                }
            });
        } else {
            loadSettings();
            if (document.querySelector('.admin-tab.active')?.dataset.tab === 'dashboard') {
                loadDashboard();
            }
        }
    </script>
</body>
</html>

