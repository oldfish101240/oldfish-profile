<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è€é­š oldfish - æ‚„æ‚„è©±ç®¡ç†å¾Œå°">
    <title>æ‚„æ‚„è©±ç®¡ç†å¾Œå° - è€é­š oldfish</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script>
        // åœ¨é é¢æ¸²æŸ“å‰ç«‹å³è®€å–ä¸¦æ‡‰ç”¨ä¸»é¡Œè¨­å®šï¼Œé¿å…é–ƒçˆ
        (function() {
            // å„ªå…ˆè®€å– URL åƒæ•¸ï¼ˆè·³è½‰æ™‚å‚³éçš„ä¸»é¡Œï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const urlTheme = urlParams.get('theme');
            let theme;

            if (urlTheme === 'dark' || urlTheme === 'light') {
                // å¦‚æœ URL ä¸­æœ‰ä¸»é¡Œåƒæ•¸ï¼Œä½¿ç”¨å®ƒä¸¦æ›´æ–° localStorage
                theme = urlTheme;
                localStorage.setItem('theme', theme);
            } else {
                // å¦å‰‡å¾ localStorage è®€å–
                theme = localStorage.getItem('theme') || 'dark';
            }
            
            document.documentElement.setAttribute('data-theme', theme);
            if (document.body) {
                document.body.setAttribute('data-theme', theme);
            }
        })();
    </script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .admin-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .admin-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .messages-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .messages-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .messages-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .messages-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .message-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }
        
        .message-item:hover {
            background: var(--bg-section);
        }
        
        .message-item:last-child {
            border-bottom: none;
        }
        
        .message-item.unread {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .message-info {
            flex: 1;
        }
        
        .message-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .message-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .message-time {
            color: var(--text-light);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .message-content {
            color: var(--text-primary);
            line-height: 1.6;
            white-space: pre-wrap;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-main);
            border-radius: 8px;
        }
        
        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-mark-read {
            background: var(--primary);
            color: white;
        }
        
        .btn-mark-read:hover {
            background: var(--primary-dark);
        }
        
        .btn-delete {
            background: var(--accent);
            color: white;
        }
        
        .btn-delete:hover {
            background: #7C3AED;
        }
        
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-state-text {
            font-size: 1.2rem;
        }
        
        .refresh-btn {
            padding: 0.75rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }
            
            .admin-title {
                font-size: 2rem;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .message-header {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .message-time {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è£é£¾å…ƒç´  -->
    <div class="bg-decoration">
        <div class="floating-shape shape-1"></div>
        <div class="floating-shape shape-2"></div>
        <div class="floating-shape shape-3"></div>
    </div>

    <!-- å°èˆªåˆ— -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="https://oldfish101240.github.io/oldfish-profile/index.html" style="text-decoration: none; color: inherit;">
                    <span class="logo-text">è€é­šoldfish</span>
                </a>
            </div>
            <div class="nav-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œ">
                    <svg class="theme-icon theme-icon-sun" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <svg class="theme-icon theme-icon-moon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M17.293 13.293C16.3785 14.2075 15.2354 14.8641 13.9959 15.2049C12.7564 15.5457 11.4578 15.5608 10.2106 15.2484C8.96335 14.936 7.80909 14.3046 6.87063 13.4161C5.93217 12.5276 5.24026 11.4127 4.86129 10.1801C4.48233 8.94756 4.42894 7.63681 4.70654 6.37518C4.98414 5.11355 5.58338 3.93846 6.44998 3.07187C7.31657 2.20527 8.49166 1.60604 9.75329 1.32844C11.0149 1.05084 12.3257 1.10423 13.5582 1.48319C14.7908 1.86215 15.9057 2.55407 16.7942 3.49253C17.6827 4.43099 18.3141 5.58525 18.6265 6.83246C18.9389 8.07967 18.9238 9.37828 18.583 10.6178C18.2422 11.8573 17.5856 13.0004 16.671 13.915L17.293 13.293Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- ç®¡ç†å¾Œå°å…§å®¹ -->
    <section class="section section-contact" style="padding-top: 8rem;">
        <div class="admin-container">
            <div class="admin-header">
                <h1 class="admin-title">æ‚„æ‚„è©±ç®¡ç†å¾Œå°</h1>
                <p class="admin-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ”¶åˆ°çš„æ‚„æ‚„è©±è¨Šæ¯</p>
            </div>
            
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-label">ç¸½è¨Šæ¯æ•¸</div>
                    <div class="stat-value" id="totalMessages">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœªè®€è¨Šæ¯</div>
                    <div class="stat-value" id="unreadMessages">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·²è®€è¨Šæ¯</div>
                    <div class="stat-value" id="readMessages">0</div>
                </div>
            </div>
            
            <!-- è¨Šæ¯åˆ—è¡¨ -->
            <div class="messages-container">
                <div class="messages-header">
                    <h2 class="messages-title">æ‰€æœ‰è¨Šæ¯</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="refresh-btn" onclick="loadMessages()">ğŸ”„ é‡æ–°æ•´ç†</button>
                        <button class="refresh-btn" onclick="showChangePasswordDialog()" style="background: var(--gradient-secondary);">ğŸ” æ›´æ”¹å¯†ç¢¼</button>
                    </div>
                </div>
                <div class="messages-list" id="messagesList">
                    <!-- è¨Šæ¯å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </section>

    <!-- é å°¾ -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 è€é­š oldfish.</p>
                <p class="footer-note">(æœ¬é é¢ç”±cursorè¼”åŠ©è£½ä½œ)</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // ============================================
        // å¯†ç¢¼ä¿è­·ï¼ˆä½¿ç”¨é›œæ¹Šï¼‰
        // ============================================
        const PASSWORD_HASH_KEY = 'admin_password_hash';
        const AUTH_KEY = 'admin_authenticated';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24å°æ™‚
        
        // ä½¿ç”¨ SHA-256 é›œæ¹Šå¯†ç¢¼
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼ï¼ˆåƒ…åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ï¼‰
        async function initDefaultPassword() {
            const existingHash = localStorage.getItem(PASSWORD_HASH_KEY);
            if (!existingHash) {
                // é è¨­å¯†ç¢¼ï¼šAndy0228
                const defaultHash = await hashPassword('Andy0228');
                localStorage.setItem(PASSWORD_HASH_KEY, defaultHash);
                console.log('å·²åˆå§‹åŒ–é è¨­å¯†ç¢¼');
            }
        }
        
        // é©—è­‰å¯†ç¢¼
        async function verifyPassword(inputPassword) {
            const storedHash = localStorage.getItem(PASSWORD_HASH_KEY);
            if (!storedHash) {
                await initDefaultPassword();
                return await verifyPassword(inputPassword);
            }
            const inputHash = await hashPassword(inputPassword);
            return inputHash === storedHash;
        }
        
        // æ›´æ”¹å¯†ç¢¼
        async function changePassword(oldPassword, newPassword) {
            const isValid = await verifyPassword(oldPassword);
            if (!isValid) {
                return { success: false, message: 'èˆŠå¯†ç¢¼éŒ¯èª¤' };
            }
            if (newPassword.length < 4) {
                return { success: false, message: 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 4 å€‹å­—å…ƒ' };
            }
            const newHash = await hashPassword(newPassword);
            localStorage.setItem(PASSWORD_HASH_KEY, newHash);
            // æ¸…é™¤ç•¶å‰èªè­‰ï¼Œéœ€è¦é‡æ–°ç™»å…¥
            sessionStorage.removeItem(AUTH_KEY);
            return { success: true, message: 'å¯†ç¢¼å·²æ›´æ”¹ï¼Œè«‹é‡æ–°ç™»å…¥' };
        }
        
        function checkAuth() {
            const authData = sessionStorage.getItem(AUTH_KEY);
            if (authData) {
                const { timestamp, authenticated } = JSON.parse(authData);
                const now = Date.now();
                // æª¢æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆæ™‚é–“å…§ï¼ˆ24å°æ™‚ï¼‰
                if (authenticated && (now - timestamp) < SESSION_DURATION) {
                    return true;
                } else {
                    // éæœŸï¼Œæ¸…é™¤èªè­‰
                    sessionStorage.removeItem(AUTH_KEY);
                }
            }
            return false;
        }
        
        function showPasswordPrompt() {
            // éš±è—ä¸»è¦å…§å®¹
            const mainContent = document.querySelector('.section');
            if (mainContent) {
                mainContent.style.display = 'none';
            }
            
            // å‰µå»ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
            const passwordContainer = document.createElement('div');
            passwordContainer.id = 'passwordContainer';
            passwordContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--bg-main);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            passwordContainer.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 3rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                ">
                    <h2 style="
                        font-size: 2rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 0.5rem;
                    ">ç®¡ç†å¾Œå°</h2>
                    <p style="
                        color: var(--text-secondary);
                        margin-bottom: 2rem;
                    ">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
                    <input type="password" id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" style="
                        width: 100%;
                        padding: 1rem;
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        background: var(--bg-main);
                        color: var(--text-primary);
                        font-size: 1rem;
                        margin-bottom: 1rem;
                        font-family: inherit;
                        transition: all 0.3s ease;
                    " autofocus>
                    <div id="errorMessage" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <button id="submitPassword" style="
                        width: 100%;
                        padding: 1rem;
                        background: var(--gradient-primary);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 1.1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">ç¢ºèª</button>
                </div>
            `;
            
            document.body.appendChild(passwordContainer);
            
            const passwordInput = document.getElementById('passwordInput');
            const submitBtn = document.getElementById('submitPassword');
            const errorMsg = document.getElementById('errorMessage');
            
            async function handleSubmit() {
                const password = passwordInput.value.trim();
                if (!password) {
                    errorMsg.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'é©—è­‰ä¸­...';
                
                try {
                    // åˆå§‹åŒ–é è¨­å¯†ç¢¼ï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰
                    await initDefaultPassword();
                    
                    const isValid = await verifyPassword(password);
                    if (isValid) {
                        // èªè­‰æˆåŠŸ
                        const authData = {
                            authenticated: true,
                            timestamp: Date.now()
                        };
                        sessionStorage.setItem(AUTH_KEY, JSON.stringify(authData));
                        passwordContainer.remove();
                        if (mainContent) {
                            mainContent.style.display = '';
                        }
                        // è¼‰å…¥è¨Šæ¯
                        if (typeof loadMessages === 'function') {
                            loadMessages();
                        }
                    } else {
                        // å¯†ç¢¼éŒ¯èª¤
                        errorMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';
                        errorMsg.style.display = 'block';
                        passwordInput.value = '';
                        passwordInput.focus();
                        passwordInput.style.borderColor = '#EF4444';
                        setTimeout(() => {
                            passwordInput.style.borderColor = '';
                        }, 2000);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ç¢ºèª';
                    }
                } catch (error) {
                    console.error('é©—è­‰å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç¢ºèª';
                }
            }
            
            submitBtn.addEventListener('click', handleSubmit);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
            });
        }
        
        // æ›´æ”¹å¯†ç¢¼å°è©±æ¡†
        function showChangePasswordDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'changePasswordDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 2.5rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 450px;
                    width: 90%;
                ">
                    <h3 style="
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 1.5rem;
                    ">æ›´æ”¹å¯†ç¢¼</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">èˆŠå¯†ç¢¼</label>
                        <input type="password" id="oldPasswordInput" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        " autofocus>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPasswordInput" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘4å€‹å­—å…ƒï¼‰" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        ">
                    </div>
                    <div id="changePasswordError" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div id="changePasswordSuccess" style="
                        color: #10B981;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button id="confirmChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--gradient-primary);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">ç¢ºèªæ›´æ”¹</button>
                        <button id="cancelChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--bg-section);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmBtn = document.getElementById('confirmChangePassword');
            const cancelBtn = document.getElementById('cancelChangePassword');
            const errorMsg = document.getElementById('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            
            async function handleChangePassword() {
                const oldPassword = oldPasswordInput.value.trim();
                const newPassword = newPasswordInput.value.trim();
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                if (!oldPassword || !newPassword) {
                    errorMsg.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'è™•ç†ä¸­...';
                
                try {
                    const result = await changePassword(oldPassword, newPassword);
                    if (result.success) {
                        successMsg.textContent = result.message;
                        successMsg.style.display = 'block';
                        setTimeout(() => {
                            dialog.remove();
                            // é‡æ–°é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
                            showPasswordPrompt();
                        }, 2000);
                    } else {
                        errorMsg.textContent = result.message;
                        errorMsg.style.display = 'block';
                        oldPasswordInput.value = '';
                        newPasswordInput.value = '';
                        oldPasswordInput.focus();
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                    }
                } catch (error) {
                    console.error('æ›´æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                }
            }
            
            confirmBtn.addEventListener('click', handleChangePassword);
            cancelBtn.addEventListener('click', () => dialog.remove());
            
            // Enter éµæäº¤
            newPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChangePassword();
                }
            });
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼
        initDefaultPassword();
        
        // æ›´æ”¹å¯†ç¢¼å°è©±æ¡†
        function showChangePasswordDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'changePasswordDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: var(--bg-card);
                    padding: 2.5rem;
                    border-radius: 24px;
                    box-shadow: var(--shadow-xl);
                    border: 1px solid var(--border-color);
                    max-width: 450px;
                    width: 90%;
                ">
                    <h3 style="
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 1.5rem;
                    ">æ›´æ”¹å¯†ç¢¼</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">èˆŠå¯†ç¢¼</label>
                        <input type="password" id="oldPasswordInput" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        " autofocus>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: var(--text-primary);
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPasswordInput" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘4å€‹å­—å…ƒï¼‰" style="
                            width: 100%;
                            padding: 0.9rem;
                            border: 2px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-main);
                            color: var(--text-primary);
                            font-size: 1rem;
                            font-family: inherit;
                        ">
                    </div>
                    <div id="changePasswordError" style="
                        color: #EF4444;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div id="changePasswordSuccess" style="
                        color: #10B981;
                        font-size: 0.9rem;
                        margin-bottom: 1rem;
                        min-height: 1.5rem;
                        display: none;
                    "></div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button id="confirmChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--gradient-primary);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">ç¢ºèªæ›´æ”¹</button>
                        <button id="cancelChangePassword" style="
                            flex: 1;
                            padding: 0.9rem;
                            background: var(--bg-section);
                            color: var(--text-primary);
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmBtn = document.getElementById('confirmChangePassword');
            const cancelBtn = document.getElementById('cancelChangePassword');
            const errorMsg = document.getElementById('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            
            async function handleChangePassword() {
                const oldPassword = oldPasswordInput.value.trim();
                const newPassword = newPasswordInput.value.trim();
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                if (!oldPassword || !newPassword) {
                    errorMsg.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                    errorMsg.style.display = 'block';
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'è™•ç†ä¸­...';
                
                try {
                    const result = await changePassword(oldPassword, newPassword);
                    if (result.success) {
                        successMsg.textContent = result.message;
                        successMsg.style.display = 'block';
                        setTimeout(() => {
                            dialog.remove();
                            // é‡æ–°é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥ç•Œé¢
                            showPasswordPrompt();
                        }, 2000);
                    } else {
                        errorMsg.textContent = result.message;
                        errorMsg.style.display = 'block';
                        oldPasswordInput.value = '';
                        newPasswordInput.value = '';
                        oldPasswordInput.focus();
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                    }
                } catch (error) {
                    console.error('æ›´æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    errorMsg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                    errorMsg.style.display = 'block';
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ç¢ºèªæ›´æ”¹';
                }
            }
            
            confirmBtn.addEventListener('click', handleChangePassword);
            cancelBtn.addEventListener('click', () => dialog.remove());
            
            // Enter éµæäº¤
            newPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChangePassword();
                }
            });
        }
        
        // åˆå§‹åŒ–é è¨­å¯†ç¢¼
        initDefaultPassword();
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥èªè­‰
        if (!checkAuth()) {
            // å¦‚æœ DOM å·²è¼‰å…¥ï¼Œç«‹å³é¡¯ç¤ºå¯†ç¢¼æç¤º
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showPasswordPrompt);
            } else {
                showPasswordPrompt();
            }
        }
        
        // è¼‰å…¥è¨Šæ¯
        function loadMessages() {
            // èª¿è©¦ï¼šæª¢æŸ¥ localStorage æ˜¯å¦å¯ç”¨
            console.log('ç•¶å‰é é¢ origin:', window.location.origin);
            console.log('localStorage æ˜¯å¦å¯ç”¨:', typeof(Storage) !== "undefined");
            
            // å˜—è©¦è®€å–æ‰€æœ‰ç›¸é—œçš„ key
            console.log('æ‰€æœ‰ localStorage keys:', Object.keys(localStorage));
            
            const rawData = localStorage.getItem('whisperMessages');
            console.log('å¾ localStorage è®€å–çš„åŸå§‹è³‡æ–™:', rawData);
            console.log('è³‡æ–™é¡å‹:', typeof rawData);
            
            // å¦‚æœè®€å–ä¸åˆ°ï¼Œå˜—è©¦å…¶ä»–å¯èƒ½çš„ key
            if (!rawData) {
                console.warn('è­¦å‘Šï¼šç„¡æ³•è®€å– whisperMessagesï¼Œå˜—è©¦å…¶ä»–æ–¹å¼...');
                // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ ¼å¼çš„è³‡æ–™
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('whisper') || key.includes('message')) {
                        console.log('æ‰¾åˆ°ç›¸é—œ key:', key, '=', localStorage.getItem(key));
                    }
                }
            }
            
            let messages = [];
            try {
                messages = JSON.parse(rawData || '[]');
            } catch (error) {
                console.error('è§£æè¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                messages = [];
            }
            
            console.log('è§£æå¾Œçš„è¨Šæ¯:', messages);
            console.log('è¨Šæ¯æ•¸é‡:', messages.length);
            
            const messagesList = document.getElementById('messagesList');
            if (!messagesList) {
                console.error('æ‰¾ä¸åˆ° messagesList å…ƒç´ ');
                return;
            }
            
            // æ›´æ–°çµ±è¨ˆ
            const total = messages.length;
            const unread = messages.filter(m => !m.read).length;
            const read = total - unread;
            
            const totalEl = document.getElementById('totalMessages');
            const unreadEl = document.getElementById('unreadMessages');
            const readEl = document.getElementById('readMessages');
            
            if (totalEl) totalEl.textContent = total;
            if (unreadEl) unreadEl.textContent = unread;
            if (readEl) readEl.textContent = read;
            
            // æ¸…ç©ºåˆ—è¡¨
            messagesList.innerHTML = '';
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-text">ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯</div>
                        <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                            æç¤ºï¼šè«‹åœ¨ contact.html æäº¤è¨Šæ¯å¾Œå†ä¾†æŸ¥çœ‹
                        </div>
                    </div>
                `;
                return;
            }
            
            // é¡¯ç¤ºè¨Šæ¯
            messages.forEach(message => {
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${message.read ? '' : 'unread'}`;
                messageItem.id = `message-${message.id}`;
                
                const date = new Date(message.timestamp);
                const formattedDate = date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageItem.innerHTML = `
                    <div class="message-header">
                        <div class="message-info">
                            <div class="message-name">${escapeHtml(message.name)}</div>
                            <div class="message-email">${escapeHtml(message.email)}</div>
                        </div>
                        <div class="message-time">${formattedDate}</div>
                    </div>
                    <div class="message-content">${escapeHtml(message.message)}</div>
                    <div class="message-actions">
                        ${!message.read ? `<button class="btn-action btn-mark-read" onclick="markAsRead(${message.id})">æ¨™è¨˜ç‚ºå·²è®€</button>` : ''}
                        <button class="btn-action btn-delete" onclick="deleteMessage(${message.id})">åˆªé™¤</button>
                    </div>
                `;
                
                messagesList.appendChild(messageItem);
            });
        }
        
        // æ¨™è¨˜ç‚ºå·²è®€
        function markAsRead(id) {
            let messages = JSON.parse(localStorage.getItem('whisperMessages') || '[]');
            const message = messages.find(m => m.id === id);
            if (message) {
                message.read = true;
                localStorage.setItem('whisperMessages', JSON.stringify(messages));
                loadMessages();
            }
        }
        
        // åˆªé™¤è¨Šæ¯
        function deleteMessage(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡è¨Šæ¯å—ï¼Ÿ')) {
                let messages = JSON.parse(localStorage.getItem('whisperMessages') || '[]');
                messages = messages.filter(m => m.id !== id);
                localStorage.setItem('whisperMessages', JSON.stringify(messages));
                loadMessages();
            }
        }
        
        // HTML è½‰ç¾©ï¼ˆé˜²æ­¢ XSSï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // é é¢è¼‰å…¥æ™‚è¼‰å…¥è¨Šæ¯
        function initAdmin() {
            console.log('ç®¡ç†å¾Œå°é é¢å·²è¼‰å…¥');
            try {
                loadMessages();
            } catch (error) {
                console.error('è¼‰å…¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                const messagesList = document.getElementById('messagesList');
                if (messagesList) {
                    messagesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">è¼‰å…¥è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤</div>
                            <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                éŒ¯èª¤ï¼š${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAdmin);
        } else {
            // å¦‚æœ DOM å·²è¼‰å…¥ï¼Œç¨ç­‰ä¸€ä¸‹ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“
            setTimeout(initAdmin, 100);
        }
        
        // æ·»åŠ èª¿è©¦åŠŸèƒ½ï¼šåœ¨æ§åˆ¶å°é¡¯ç¤ºæ‰€æœ‰è¨Šæ¯
        window.debugMessages = function() {
            const messages = JSON.parse(localStorage.getItem('whisperMessages') || '[]');
            console.table(messages);
            console.log('è¨Šæ¯æ•¸é‡:', messages.length);
            return messages;
        };
        
        // æ‰‹å‹•é‡æ–°è¼‰å…¥è¨Šæ¯
        window.reloadMessages = function() {
            console.log('æ‰‹å‹•é‡æ–°è¼‰å…¥è¨Šæ¯');
            loadMessages();
        };
        
        console.log('æç¤ºï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ debugMessages() å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è¨Šæ¯');
        console.log('æç¤ºï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ reloadMessages() å¯ä»¥é‡æ–°è¼‰å…¥è¨Šæ¯');
    </script>
</body>
</html>

